<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deafbakery - æº«æš–è·äººçµ„ç¹”åœ–</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React æ ¸å¿ƒ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. è¨­å®š Tailwind æ“´å……æ¨£å¼ (æº«æš–è·äººé¢¨) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        artisan: {
                            bg: '#F9F7F2',        // ç´™å¼µç±³ç™½
                            ink: '#4A3B32',       // æº«æš–æ·±è¤ (æ–‡å­—/é‚Šæ¡†)
                            gold: '#D4A373',      // çƒ˜ç„™é‡‘
                            cream: '#FFFDF5',     // å¥¶æ²¹ç™½ (å¡ç‰‡èƒŒæ™¯)
                            accent: '#E76F51',    // ç£šç´…/æ´»åŠ›æ©˜ (å¼·èª¿)
                            gray: '#9C8E85',      // è³ªæ„Ÿç°
                            
                            // éƒ¨é–€è‰²ç³» (ä½é£½å’Œæ‰‹ç¹ªæ„Ÿ)
                            red: '#F4DCD6',       // æŸ”ç²‰
                            blue: '#D6E4F0',      // éœ§è—
                            green: '#DBE7C9',     // æŠ¹èŒ¶ç¶ 
                            purple: '#E6DEEB',    // è–°è¡£è‰
                            yellow: '#FDF6D3',    // å¡å£«é”é»ƒ
                        }
                    },
                    boxShadow: {
                        'sketch': '3px 3px 0px 0px #4A3B32', // æ‰‹ç¹ªé¢¨å¯¦å¿ƒé™°å½±
                        'sketch-sm': '1.5px 1.5px 0px 0px #4A3B32',
                        'sketch-hover': '5px 5px 0px 0px #D4A373',
                    },
                    borderRadius: {
                        'hand': '255px 15px 225px 15px / 15px 225px 15px 255px', // æ¨¡æ“¬æ‰‹ç¹ªä¸è¦å‰‡åœ“è§’
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Zen Maru Gothic"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'wiggle': 'wiggle 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-4px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-1deg)' },
                            '50%': { transform: 'rotate(1deg)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=Noto+Serif+TC:wght@600;900&display=swap');

        body { 
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; 
            background-color: #F9F7F2;
            color: #4A3B32;
            /* ç´™å¼µç´‹ç†æ•ˆæœ */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23D4A373' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D4A373; border-radius: 10px; border: 3px solid #F9F7F2; }
        ::-webkit-scrollbar-thumb:hover { background: #4A3B32; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // --- Error Boundary (é˜²ç•¶æ©Ÿå®ˆé–€å“¡) ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex items-center justify-center h-screen bg-artisan-bg p-10 text-center">
                            <div className="bg-white p-8 rounded-hand border-2 border-dashed border-red-400 shadow-sketch">
                                <h2 className="text-2xl font-bold text-artisan-accent mb-4">å“å‘€ï¼è³‡æ–™çµæ§‹æœ‰é»å°å•é¡Œ</h2>
                                <p className="text-artisan-ink mb-4">å¯èƒ½æ˜¯å› ç‚ºäººå“¡ä¹‹é–“çš„ã€Œä¸Šä¸‹ç´šé—œä¿‚ã€ç”¢ç”Ÿäº†ç„¡é™è¿´åœˆã€‚</p>
                                <p className="text-xs text-gray-500 font-mono bg-gray-100 p-2 rounded">{this.state.error.toString()}</p>
                                <button onClick={() => window.location.reload()} className="mt-6 px-6 py-2 bg-artisan-ink text-white rounded-lg font-bold">é‡æ–°æ•´ç†</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- 1. Icons (æ‰‹ç¹ªåœ“æ½¤é¢¨æ ¼) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Search: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM5.7 17.25a8.25 8.25 0 1110.25-10.25 8.25 8.25 0 01-10.25 10.25zm9.9 1.8l3.9 3.9a.75.75 0 11-1.06 1.06l-3.9-3.9a.75.75 0 111.06-1.06z" clipRule="evenodd" />} />,
            ZoomIn: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM5.7 17.25a8.25 8.25 0 1110.25-10.25 8.25 8.25 0 01-10.25 10.25zm9.9 1.8l3.9 3.9a.75.75 0 11-1.06 1.06l-3.9-3.9a.75.75 0 111.06-1.06zM11.25 7.5a.75.75 0 00-1.5 0v2.25H7.5a.75.75 0 000 1.5h2.25v2.25a.75.75 0 001.5 0v-2.25h2.25a.75.75 0 000-1.5h-2.25V7.5z" clipRule="evenodd" />} />,
            ZoomOut: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM5.7 17.25a8.25 8.25 0 1110.25-10.25 8.25 8.25 0 01-10.25 10.25zm9.9 1.8l3.9 3.9a.75.75 0 11-1.06 1.06l-3.9-3.9a.75.75 0 111.06-1.06zM7.5 10.5a.75.75 0 000 1.5h6a.75.75 0 000-1.5h-6z" clipRule="evenodd" />} />,
            Edit: (props) => <Icon {...props} path={<path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32l8.4-8.4z" /><path d="M5.25 5.25a3 3 0 00-3 3v10.5a3 3 0 003 3h10.5a3 3 0 003-3V13.5a.75.75 0 00-1.5 0v5.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5V8.25a1.5 1.5 0 011.5-1.5h5.25a.75.75 0 000-1.5H5.25z" />} />,
            Save: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M7.5 3.75A1.5 1.5 0 006 5.25v13.5a1.5 1.5 0 001.5 1.5h9a1.5 1.5 0 001.5-1.5V7.65a1.5 1.5 0 00-.44-1.06l-2.65-2.65a1.5 1.5 0 00-1.06-.44H7.5zm1.5 1.5h4.5a.75.75 0 010 1.5h-4.5a.75.75 0 010-1.5zM7.5 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM8.25 15a.75.75 0 000 1.5h7.5a.75.75 0 000-1.5h-7.5z" clipRule="evenodd" />} />,
            X: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clipRule="evenodd" />} />,
            User: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clipRule="evenodd" />} />,
            Users: (props) => <Icon {...props} path={<path d="M4.5 6.375a4.125 4.125 0 118.25 0 4.125 4.125 0 01-8.25 0zM14.25 8.625a3.375 3.375 0 116.75 0 3.375 3.375 0 01-6.75 0zM1.5 19.125a7.125 7.125 0 0114.25 0v.003l-.001.119a.75.75 0 01-.363.63 13.067 13.067 0 01-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 01-.364-.63l-.001-.122zM17.25 19.125a7.125 7.125 0 0114.25 0v.003l-.001.119a.75.75 0 01-.363.63 13.067 13.067 0 01-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 01-.364-.63l-.001-.122z" />} />,
            Building: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M4.5 2.25a.75.75 0 00-.75.75v18a.75.75 0 00.75.75h15a.75.75 0 00.75-.75V3a.75.75 0 00-.75-.75H4.5zm1.5 1.5h12v16.5H6V3.75zm3 3.75a.75.75 0 01.75-.75h3a.75.75 0 01.75.75v2.25a.75.75 0 01-.75.75h-3a.75.75 0 01-.75-.75V7.5zm.75 6a.75.75 0 00-1.5 0v2.25a.75.75 0 001.5 0V13.5zM12 13.5a.75.75 0 00-1.5 0v2.25a.75.75 0 001.5 0V13.5zm3.75-.75a.75.75 0 01.75.75v2.25a.75.75 0 01-.75.75h-3a.75.75 0 01-.75-.75V13.5a.75.75 0 01.75-.75h3z" clipRule="evenodd" />} />,
            Layers: (props) => <Icon {...props} path={<path d="M11.25 3a.75.75 0 00-1.5 0v2.25a.75.75 0 001.5 0V3zM15.75 3a.75.75 0 00-1.5 0v2.25a.75.75 0 001.5 0V3zM19.5 3.75a.75.75 0 01.75.75v15a.75.75 0 01-.75.75H4.5a.75.75 0 01-.75-.75V4.5a.75.75 0 01.75-.75h15zM6 5.25v13.5h12V5.25H6zM10.5 8.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zM15 8.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zM10.5 12.75a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V13.5a.75.75 0 01.75-.75zM15 12.75a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V13.5a.75.75 0 01.75-.75z" />} />,
            List: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M2.25 6a.75.75 0 01.75-.75h18a.75.75 0 010 1.5H3a.75.75 0 01-.75-.75zM2.25 12a.75.75 0 01.75-.75h18a.75.75 0 010 1.5H3a.75.75 0 01-.75-.75zM2.25 18a.75.75 0 01.75-.75h18a.75.75 0 010 1.5H3a.75.75 0 01-.75-.75z" clipRule="evenodd" />} />,
            Layout: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M4.5 2.25A2.25 2.25 0 002.25 4.5v15a2.25 2.25 0 002.25 2.25h15a2.25 2.25 0 002.25-2.25V4.5a2.25 2.25 0 00-2.25-2.25H4.5zm-.75 2.25a.75.75 0 01.75-.75h15a.75.75 0 01.75.75v4.5a.75.75 0 01-.75.75H4.5a.75.75 0 01-.75-.75V4.5zm0 6a.75.75 0 01.75-.75h4.5a.75.75 0 01.75.75v9.75a.75.75 0 01-.75.75H4.5a.75.75 0 01-.75-.75V10.5zm6.75-.75a.75.75 0 00-1.5 0v9.75a.75.75 0 001.5 0V9.75zM20.25 9a.75.75 0 01-.75.75h-4.5a.75.75 0 01-.75-.75V9a.75.75 0 011.5 0v-.75a.75.75 0 01.75-.75h4.5a.75.75 0 01.75.75v9.75a.75.75 0 01-.75.75H12a.75.75 0 01-.75-.75V9z" clipRule="evenodd" />} />,
            Lock: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a3 3 0 00-3 3v6.75a3 3 0 003 3h10.5a3 3 0 003-3v-6.75a3 3 0 00-3-3v-3c0-2.9-2.35-5.25-5.25-5.25zm3.75 8.25v-3a3.75 3.75 0 10-7.5 0v3h7.5z" clipRule="evenodd" />} />,
            KeyRound: (props) => <Icon {...props} path={<path fillRule="evenodd" d="M15.75 1.5a6.75 6.75 0 00-6.65 7.93L2.868 15.671a.75.75 0 00-.22.434l-.003.04-.004.056v3.002c0 .414.336.75.75.75h3a.75.75 0 00.75-.75v-1.5h1.5a.75.75 0 00.75-.75v-1.5h1.5a.75.75 0 00.75-.75V14l3.98-3.98A6.75 6.75 0 0015.75 1.5zm0 3a3.75 3.75 0 110 7.5 3.75 3.75 0 010-7.5z" clipRule="evenodd" />} />,
            Chef: (props) => <Icon {...props} path={<path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 9.08 0A5.11 5.11 0 0 1 18.59 6 4 4 0 0 1 20 13.87V21H6Z"/><path d="M6 17h14" />} />,
            Heart: (props) => <Icon {...props} path={<path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />} />
        };

        // --- 2. åˆå§‹è³‡æ–™ ---
        const INITIAL_CSV = `ID,Name,TechTitle,MgmtTitle,ParentID
CEO,æ½˜ä¿¡å®,,åŸ·è¡Œé•·,
COO,æ½˜é‡æ©,,ç‡Ÿé‹é•·,CEO
C_PROD,ç”Ÿç”¢ä¸­å¿ƒ,,ä¸­å¿ƒ,COO
C_LOGI,ç‰©æµä¸­å¿ƒ,,ä¸­å¿ƒ,COO
C_OPS,ç‡Ÿé‹ä¸­å¿ƒ,,ä¸­å¿ƒ,COO
C_MGM,ç®¡ç†ä¸­å¿ƒ,,ä¸­å¿ƒ,COO
D_PROD,ç”Ÿç”¢éƒ¨,,éƒ¨é–€,ç¾…æœˆæƒ 
D_PKG,åŒ…è£éƒ¨,,éƒ¨é–€,C_PROD
D_SHIP,å‡ºè²¨éƒ¨,,éƒ¨é–€,C_LOGI
D_LOGI,ç‰©æµéƒ¨,,éƒ¨é–€,C_LOGI
D_MKT,è¡ŒéŠ·éƒ¨,,éƒ¨é–€,C_OPS
D_SALES,éŠ·å”®éƒ¨,,éƒ¨é–€,C_OPS
D_CS,å®¢æœéƒ¨,,éƒ¨é–€,C_OPS
D_BD,å•†å‹™æ‹“å±•éƒ¨,,éƒ¨é–€,C_OPS
D_ADMIN,ç®¡ç†éƒ¨,,éƒ¨é–€,C_MGM
D_RD,ç ”ç™¼éƒ¨,,éƒ¨é–€,C_PROD
G_PM,å°ˆæ¡ˆç®¡ç†çµ„,,çµ„åˆ¥,é‚±å¤¢æ¶µ
G_ART,ç¾ç·¨çµ„,,çµ„åˆ¥,é‚±å¤¢æ¶µ
G_SNS,ç¤¾ç¾¤çµ„,,çµ„åˆ¥,é‚±å¤¢æ¶µ
G_PLAN,ä¼åŠƒçµ„,,çµ„åˆ¥,é‚±å¤¢æ¶µ
G_HR,äººåŠ›è³‡æºçµ„,,çµ„åˆ¥,D_ADMIN
G_GA,ç¸½å‹™è¡Œæ”¿çµ„,,çµ„åˆ¥,D_ADMIN
G_FIN,è²¡å‹™çµ„,,çµ„åˆ¥,D_ADMIN
G_IT,è³‡è¨Šç®¡ç†çµ„,,çµ„åˆ¥,D_ADMIN
G_FILL,é¤¡æ–™çµ„,,çµ„åˆ¥,D_PROD
G_CUT,åˆ‡å‰²çµ„,,çµ„åˆ¥,D_PROD
G_BAKE,çƒ˜çƒ¤çµ„,,çµ„åˆ¥,D_PROD
ç¾…æœˆæƒ ,ç¾…æœˆæƒ ,,ç¸½ç›£,C_PROD
å³å¤¢å©·,å³å¤¢å©·,,ç¶“ç†,D_BD
é™³å·§çŠ,é™³å·§çŠ,æ¥­å‹™å°ˆå“¡,,å³å¤¢å©·
é‚±å®—ä»,é‚±å®—ä»,ç‰©æµå°ˆå“¡,è¥„ç†,D_LOGI
è¬å‘ˆå¼¦,è¬å‘ˆå¼¦,ç‰©æµå°ˆå“¡,,é‚±å®—ä»
æå»ºèˆˆ,æå»ºèˆˆ,ç‰©æµå°ˆå“¡,,é‚±å®—ä»
è³´éŸ‹ä»²,è³´éŸ‹ä»²,ç†è²¨å°ˆå“¡,è¥„ç†,D_SHIP
èŠäºæ®,èŠäºæ®,ç†è²¨å°ˆå“¡,,è³´éŸ‹ä»²
ç¾…è™¹æ—»,ç¾…è™¹æ—»,ç†è²¨å°ˆå“¡,çµ„é•·,è³´éŸ‹ä»²
ç‹æƒ ç¦,ç‹æƒ ç¦,ç†è²¨å°ˆå“¡,çµ„é•·,è³´éŸ‹ä»²
è³´ç‘æ± ,è³´ç‘æ± ,ç†è²¨å°ˆå“¡,,è³´éŸ‹ä»²
å¼µç†’å€«,å¼µç†’å€«,ç†è²¨å“¡,,è³´éŸ‹ä»²
æ—æ·‘çª,æ—æ·‘çª,ç†è²¨å°ˆå“¡,,è³´éŸ‹ä»²
é™³çŸå©•,é™³çŸå©•,ç†è²¨å°ˆå“¡,,è³´éŸ‹ä»²
è—å¿ç¢§,è—å¿ç¢§,ç†è²¨å“¡,,è³´éŸ‹ä»²
é™³å·å€ª,é™³å·å€ª,ç†è²¨å“¡,,è³´éŸ‹ä»²
ç¾…å† ç³,ç¾…å† ç³,ç†è²¨å“¡,,è³´éŸ‹ä»²
è¬ç§€å¿,è¬ç§€å¿,ç†è²¨å“¡,,è³´éŸ‹ä»²
å¼µæ²›å«º,å¼µæ²›å«º,ç†è²¨å“¡,,è³´éŸ‹ä»²
é™³ç¾ä½™,é™³ç¾ä½™,ç†è²¨å“¡,,è³´éŸ‹ä»²
æ—ç¾æ™´,æ—ç¾æ™´,ç†è²¨å“¡,,è³´éŸ‹ä»²
å¾ç®åº­,å¾ç®åº­,éŠ·å”®å°ˆå“¡,å„²å‚™å¹¹éƒ¨,é¡§åº­ç‘‹
è¨±é›…æƒ ,è¨±é›…æƒ ,éŠ·å”®äººå“¡,,å¾ç®åº­
æ½˜åè²,æ½˜åè²,éŠ·å”®äººå“¡,,å¾ç®åº­
è•­ç¾½å©·,è•­ç¾½å©·,éŠ·å”®äººå“¡,,å¾ç®åº­
é»ƒæƒ ç²,é»ƒæƒ ç²,åŒ…è£å°ˆå“¡,è¥„ç†,D_PKG
è­šæ–‡ç¦,è­šæ–‡ç¦,åŒ…è£å°ˆå“¡,çµ„é•·,é»ƒæƒ ç²
ç›§æ€¡å®‰,ç›§æ€¡å®‰,åŒ…è£å°ˆå“¡,çµ„é•·,é»ƒæƒ ç²
ç‹è‹¥è“,ç‹è‹¥è“,åŒ…è£å°ˆå“¡,çµ„é•·,é»ƒæƒ ç²
è³´ç¾½çŠ,è³´ç¾½çŠ,åŒ…è£å°ˆå“¡,,é»ƒæƒ ç²
æç¾ç²,æç¾ç²,åŒ…è£å“¡,,é»ƒæƒ ç²
è”¡é›…å§,è”¡é›…å§,åŒ…è£å“¡,,é»ƒæƒ ç²
æ¸¸é›…é›¯,æ¸¸é›…é›¯,åŒ…è£å“¡,,é»ƒæƒ ç²
ä½•å¦‚é›,ä½•å¦‚é›,åŒ…è£å“¡,,é»ƒæƒ ç²
è³´å®œè²,è³´å®œè²,åŒ…è£å“¡,,é»ƒæƒ ç²
ææ¶”ç‘œ,ææ¶”ç‘œ,åŒ…è£å“¡,,é»ƒæƒ ç²
æ²ˆå‚³ä»,æ²ˆå‚³ä»,åŒ…è£å“¡,,é»ƒæƒ ç²
æ—å¦ç¶¸,æ—å¦ç¶¸,åŒ…è£å“¡,,é»ƒæƒ ç²
åŠ‰æ˜Ÿå²‘,åŠ‰æ˜Ÿå²‘,åŒ…è£å“¡,,é»ƒæƒ ç²
åˆ©å‰éŠ¨,åˆ©å‰éŠ¨,è³‡æ·±ç ”ç™¼å°ˆå“¡,ç ”ç™¼ä¸»å»š,D_RD
å“ä½³è“‰,å“ä½³è“‰,æŠ€è¡“å°ˆå“¡,çµ„é•·,ç¾…æœˆæƒ 
ææ€¡çŠ,ææ€¡çŠ,è³‡æ·±æŠ€è¡“å°ˆå“¡,,åˆ©å‰éŠ¨
è”¡å­Ÿåº­,è”¡å­Ÿåº­,æŠ€è¡“å°ˆå“¡,çµ„é•·,ç¾…æœˆæƒ 
æ›¹æŸå‡±,æ›¹æŸå‡±,æŠ€è¡“å°ˆå“¡,çµ„é•·,ç¾…æœˆæƒ 
æ´ªå­èª¼,æ´ªå­èª¼,æŠ€è¡“å°ˆå“¡,çµ„é•·,ç¾…æœˆæƒ 
åŠ‰ç¾¿å›,åŠ‰ç¾¿å›,æŠ€è¡“å°ˆå“¡,çµ„é•·,ç¾…æœˆæƒ 
é™³æµšå®,é™³æµšå®,æŠ€è¡“å°ˆå“¡,å» å‹™,ç¾…æœˆæƒ 
é„­éœå®œ,é„­éœå®œ,æŠ€è¡“å°ˆå“¡,çµ„é•·,ç¾…æœˆæƒ 
é¾é¨„éœ‡,é¾é¨„éœ‡,æŠ€è¡“å°ˆå“¡,çµ„é•·,ç¾…æœˆæƒ 
æ±ªå»ºä½‘,æ±ªå»ºä½‘,æŠ€è¡“å°ˆå“¡,,å“ä½³è“‰
æŸ¯æ³³å®‰,æŸ¯æ³³å®‰,æŠ€è¡“å°ˆå“¡,,å“ä½³è“‰
è‘‰æ–‡ç³,è‘‰æ–‡ç³,ä½œæ¥­å“¡,,å“ä½³è“‰
é»ƒä½³ç¥º,é»ƒä½³ç¥º,ä½œæ¥­å“¡,é£Ÿå®‰ç®¡ç†äººå“¡,å“ä½³è“‰
åŠ‰æ±´è±,åŠ‰æ±´è±,ä½œæ¥­å“¡,,å“ä½³è“‰
å³æŸ”æ¼ª,å³æŸ”æ¼ª,ä½œæ¥­å“¡,,å“ä½³è“‰
é™³éŸ»åµ,é™³éŸ»åµ,ä½œæ¥­å“¡,,å“ä½³è“‰
ææ˜•åº­,ææ˜•åº­,ä½œæ¥­å“¡,,å“ä½³è“‰
è‘£ä¿Šä½‘,è‘£ä¿Šä½‘,ä½œæ¥­å“¡,,å“ä½³è“‰
æ±ªå»ºé”,æ±ªå»ºé”,ä½œæ¥­å“¡,,å“ä½³è“‰
è”¡è© ç¿”,è”¡è© ç¿”,ä½œæ¥­å“¡,,å“ä½³è“‰
è‘‰æŸå¿—,è‘‰æŸå¿—,ä½œæ¥­å“¡,,å“ä½³è“‰
é»ƒå¨æ™º,é»ƒå¨æ™º,ä½œæ¥­å“¡,,å“ä½³è“‰
æ—è¯è±,æ—è¯è±,ä½œæ¥­å“¡,,å“ä½³è“‰
è•­é–å¬™,è•­é–å¬™,ç¾ç·¨å°ˆå“¡,çµ„é•·,G_ART
é‚±å¤¢æ¶µ,é‚±å¤¢æ¶µ,è³‡æ·±å°ˆæ¡ˆåŸ·è¡Œ,ç¶“ç†,D_MKT
è˜‡ç¾¿ç‘„,è˜‡ç¾¿ç‘„,ç¤¾ç¾¤å°ˆå“¡,çµ„é•·,G_SNS
è˜‡å‡Œè±,è˜‡å‡Œè±,å°ˆæ¡ˆåŸ·è¡Œå°ˆå“¡,,G_PM
å¼µå®œå©·,å¼µå®œå©·,å°ˆæ¡ˆåŸ·è¡Œå°ˆå“¡,,G_PM
æ´ªåƒæƒŸ,æ´ªåƒæƒŸ,ç¾ç·¨å°ˆå“¡,,è•­é–å¬™
æ—å­£å«»,æ—å­£å«»,å°ˆæ¡ˆåŸ·è¡Œå°ˆå“¡,,G_PM
è¨±å¯æ¦†,è¨±å¯æ¦†,ç¤¾ç¾¤å°ç·¨,,è˜‡ç¾¿ç‘„
é™³æ¥·æ›œ,é™³æ¥·æ›œ,ç¤¾ç¾¤å°ç·¨,,è˜‡ç¾¿ç‘„
æ›¹æ«»æ¨º,æ›¹æ«»æ¨º,å°ˆæ¡ˆåŸ·è¡Œå°ˆå“¡,,G_PM
å¾è‹‘å¦®,å¾è‹‘å¦®,æœƒè¨ˆäººå“¡,,G_FIN
å»–è©©æ—»,å»–è©©æ—»,è³‡æ·±å°ˆå“¡,,G_HR
ä½•èŠ¸èŠ³,ä½•èŠ¸èŠ³,å°ˆå“¡,,G_HR
é™³ä¿Šå‰,é™³ä¿Šå‰,å°ˆå“¡,,G_GA
é„­é‹†æ…ˆ,é„­é‹†æ…ˆ,å°ˆå“¡,,G_HR
è”¡è‡»å¦®,è”¡è‡»å¦®,å°ˆå“¡,,G_GA
æ¥Šæ·¨é›¯,æ¥Šæ·¨é›¯,å°ˆå“¡,,G_GA
æ—å–¬æ˜•,æ—å–¬æ˜•,å°ˆå“¡,,G_GA
è³´ç‰ç ,è³´ç‰ç ,å°ˆå“¡,,G_GA
ç‹ä½‘çŠ,ç‹ä½‘çŠ,å®¢æœå°ˆå“¡,è¥„ç†,D_CS
æ½˜å‰é›…,æ½˜å‰é›…,å®¢æœå°ˆå“¡,,ç‹ä½‘çŠ
æ—å§¿ç©,æ—å§¿ç©,å®¢æœå°ˆå“¡,,ç‹ä½‘çŠ
é‚±æ…§å§,é‚±æ…§å§,å®¢æœå°ˆå“¡,,ç‹ä½‘çŠ
æ¸¸æ˜­çª,æ¸¸æ˜­çª,å®¢æœå°ˆå“¡,,ç‹ä½‘çŠ
é¡§åº­ç‘‹,é¡§åº­ç‘‹,,å…¼ä»»ç¶“ç†,D_SALES
æ½˜å…¨æ©,æ½˜å…¨æ©,,è³‡è¨Šé•·,G_IT`;

        // --- 3. æº«æš–æ’ç•«é¢¨æ ¼é‚è¼¯ ---

        const getLevelStyle = (level, mgmtTitle) => {
            const title = mgmtTitle || ''; 
            // åŸºç¤å¡ç‰‡æ¨£å¼ï¼šåœ“æ½¤ã€æ‰‹ç¹ªé‚Šæ¡†ã€æŸ”å’Œé™°å½±ã€æµ®å‹•å‹•ç•«
            const baseClass = "rounded-hand border-2 border-dashed transition-all duration-300 relative overflow-hidden group shadow-sketch hover:shadow-sketch-hover hover:-translate-y-1";
            
            // åŸ·è¡Œé•·/é«˜å±¤ - æº«æš–é»ƒè‰²ç³»
            if (title.includes('åŸ·è¡Œé•·') || title.includes('è‘£äº‹é•·') || title.includes('è³‡è¨Šé•·')) {
                return `${baseClass} bg-artisan-yellow/50 border-artisan-gold text-artisan-ink`;
            }
            // ç‡Ÿé‹é•·/ç¸½ç›£ - æŸ”å’Œæ©˜è‰²ç³»
            if (title.includes('ç‡Ÿé‹é•·') || title.includes('ç¸½ç¶“ç†') || title.includes('ç¸½ç›£')) {
                return `${baseClass} bg-artisan-red/50 border-artisan-accent text-artisan-ink`;
            }
            // ä¸­å¿ƒ - æº«æš–è—è‰²ç³»
            if (title.includes('ä¸­å¿ƒ')) {
                return `${baseClass} bg-artisan-blue/50 border-artisan-ink/30 text-artisan-ink`;
            }
            // éƒ¨é–€/ç¶“ç† - æŸ”å’Œç¶ è‰²ç³»
            if (title.includes('éƒ¨é–€') || title.includes('ç¶“ç†') || title.includes('è¥„ç†') || title.includes('ä¸»ä»»')) {
                return `${baseClass} bg-artisan-green/50 border-artisan-ink/30 text-artisan-ink`;
            }
            // çµ„åˆ¥/çµ„é•· - æº«æš–ç´«è‰²ç³»
            if (title.includes('çµ„åˆ¥') || title.includes('çµ„é•·') || title.includes('å¹¹éƒ¨') || title.includes('é ˜ç­') || title.includes('ç·šé•·')) {
                return `${baseClass} bg-artisan-purple/50 border-artisan-ink/30 text-artisan-ink`;
            }

            // ä¸€èˆ¬åŒä» - ç°¡ç´„ç™½
            return `${baseClass} bg-white border-artisan-ink/20 text-artisan-ink hover:border-artisan-gold`; 
        };

        // --- List View Component ---
        const ListView = ({ node, level = 0, searchTerm }) => {
            const [expanded, setExpanded] = useState(true);
            const hasChildren = node.children && node.children.length > 0;
            
            const isMatch = searchTerm && (
                node.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (node.mgmtTitle && node.mgmtTitle.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (node.techTitle && node.techTitle.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            useEffect(() => {
                if (isMatch) setExpanded(true);
            }, [isMatch]);

            if (searchTerm && !isMatch && !expanded) return null;

            const indent = level * 20;
            const hasMgmtTitle = node.mgmtTitle && node.mgmtTitle.trim() !== '';

            // åˆ—è¡¨èƒŒæ™¯é‚è¼¯ - ä½¿ç”¨æº«æš–è‰²å¡Š
            let rowBg = "bg-white/50";
            let borderColor = "border-artisan-ink/20";
            if (level === 0) { rowBg = "bg-artisan-gold/20"; borderColor = "border-artisan-gold"; }
            else if (level === 1) { rowBg = "bg-artisan-ink/5"; borderColor = "border-artisan-ink"; }
            
            return (
                <div className="w-full my-2">
                    <div 
                        className={`flex items-center p-3 rounded-lg border-2 border-dashed cursor-pointer transition-colors shadow-sketch-sm hover:shadow-sketch hover:-translate-y-0.5 ${rowBg} ${borderColor} ${isMatch ? 'ring-2 ring-artisan-accent' : ''}`}
                        style={{ marginLeft: `${indent}px`, width: `calc(100% - ${indent}px)` }}
                        onClick={() => setExpanded(!expanded)}
                    >
                        <div className="mr-3 text-artisan-ink w-6 flex justify-center">
                            {hasChildren ? (expanded ? 'â–¼' : 'â–¶') : <div className="w-2 h-2 bg-artisan-gray rounded-full"></div>}
                        </div>
                        
                        <div className="flex-1 flex flex-wrap items-center gap-2">
                            <div className="flex items-baseline gap-2">
                                <span className={`font-medium tracking-wider ${level < 2 ? 'text-lg font-bold' : ''}`}>
                                    {node.name}
                                </span>
                                {hasMgmtTitle && (
                                    <span className={`text-xs px-2 py-1 rounded-full border border-dashed font-bold bg-white/80 border-artisan-ink/50`}>
                                        {node.mgmtTitle}
                                    </span>
                                )}
                            </div>
                            {node.techTitle && (
                                <div className="text-sm text-artisan-gray font-medium italic">({node.techTitle})</div>
                            )}
                        </div>
                    </div>
                    
                    {hasChildren && expanded && (
                        <div className="animate-[fadeIn_0.3s_ease-out] border-l-2 border-dashed border-artisan-ink/10 ml-4 pl-2">
                            {node.children.map(child => (
                                <ListView key={child.id} node={child} level={level + 1} searchTerm={searchTerm} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- Chart View Components ---
        const CompactNodeGroup = ({ nodes, level, searchTerm }) => {
            return (
                <div className="flex flex-col items-center pt-6 relative">
                    {/* æ‰‹ç¹ªé€£æ¥ç·š */}
                    <svg className="absolute top-0 left-1/2 -translate-x-1/2 -mt-2 w-6 h-8" viewBox="0 0 24 32">
                        <path d="M12 0 L12 32" stroke="#4A3B32" strokeWidth="2" strokeDasharray="4 2" fill="none" strokeLinecap="round" />
                    </svg>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 bg-white/60 backdrop-blur-md p-5 rounded-hand border-2 border-dashed border-artisan-ink/30 shadow-sketch relative mt-4">
                        {nodes.map(node => {
                            const hasMgmtTitle = node.mgmtTitle && node.mgmtTitle.trim() !== '';
                            const isMatch = searchTerm && (
                                node.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                (node.mgmtTitle && node.mgmtTitle.toLowerCase().includes(searchTerm.toLowerCase())) ||
                                (node.techTitle && node.techTitle.toLowerCase().includes(searchTerm.toLowerCase()))
                            );

                            return (
                                <div 
                                    key={node.id}
                                    className={`
                                        flex flex-col p-3 bg-white rounded-lg border border-dashed border-artisan-ink/20 w-40 hover:border-artisan-gold hover:shadow-md transition-all group
                                        ${isMatch ? 'ring-2 ring-artisan-accent shadow-sketch' : ''}
                                    `}
                                >
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="font-bold text-artisan-ink truncate group-hover:text-artisan-accent transition-colors">{node.name}</span>
                                        {hasMgmtTitle && <span className="text-[10px] bg-artisan-purple text-artisan-ink border border-artisan-ink/20 px-1.5 py-0.5 rounded-full">{node.mgmtTitle}</span>}
                                    </div>
                                    {node.techTitle && <span className="text-xs text-artisan-gray truncate font-medium">{node.techTitle}</span>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const OrgNode = ({ node, level, searchTerm }) => {
            const [expanded, setExpanded] = useState(true);
            const isMatch = searchTerm && (
                node.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (node.mgmtTitle && node.mgmtTitle.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (node.techTitle && node.techTitle.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            useEffect(() => {
                if (isMatch) setExpanded(true);
            }, [isMatch]);

            const hasChildren = node.children && node.children.length > 0;
            const hasMgmtTitle = node.mgmtTitle && node.mgmtTitle.trim() !== '';
            
            const isLeafGroup = hasChildren && level > 1 && node.children.length > 2 && node.children.every(child => !child.children || child.children.length === 0);

            const getIcon = () => {
                const iconClass = "w-5 h-5 mr-2 opacity-90 text-artisan-ink";
                if (!hasMgmtTitle) return null;
                if (node.mgmtTitle.includes('é•·') || node.mgmtTitle.includes('ç›£')) return <Icons.User className={iconClass} />;
                if (node.mgmtTitle.includes('ä¸­å¿ƒ')) return <Icons.Building className={iconClass} />;
                if (node.mgmtTitle.includes('éƒ¨')) return <Icons.Layers className={iconClass} />;
                if (node.mgmtTitle.includes('çµ„')) return <Icons.Users className={iconClass} />;
                return <Icons.User className={iconClass} />;
            }

            return (
                <div className="flex flex-col items-center z-10 relative">
                    <div 
                        className={`
                            px-6 py-4 m-4 w-64 min-h-[6rem] justify-center cursor-pointer rounded-lg
                            ${getLevelStyle(level, node.mgmtTitle)}
                            ${isMatch ? 'ring-4 ring-artisan-accent shadow-sketch scale-105' : ''}
                            ${!expanded && hasChildren ? 'opacity-80 grayscale-[30%]' : ''}
                        `}
                        onClick={() => setExpanded(!expanded)}
                    >
                        {/* è£é£¾åœ–æ¡ˆ */}
                        <div className="absolute top-2 right-2 text-artisan-ink/10"><Icons.Heart className="w-5 h-5" /></div>

                        {hasMgmtTitle && (
                            <div className="flex items-center text-xl font-bold tracking-wider mb-2 border-b-2 border-dashed border-artisan-ink/10 pb-2 w-full justify-center text-artisan-ink">
                                {getIcon()}
                                {node.mgmtTitle}
                            </div>
                        )}

                        <div className={`text-lg font-bold text-center leading-tight tracking-wide text-artisan-ink ${hasMgmtTitle ? '' : 'mt-1'} ${level===0 ? 'text-2xl font-serif' : ''}`}>
                            {node.name}
                        </div>

                        {node.techTitle && (
                            <div className={`text-sm mt-3 font-medium tracking-tight px-3 py-1 rounded-full text-center border border-dashed
                                ${hasMgmtTitle ? 'text-artisan-ink/70 bg-white/40 border-white/50' : 'text-artisan-gray bg-white/50 border-artisan-ink/10'}
                            `}>
                                {node.techTitle}
                            </div>
                        )}
                        
                        {hasChildren && (
                            <div className="absolute -bottom-4 left-1/2 -translate-x-1/2 bg-artisan-cream rounded-full w-8 h-8 flex items-center justify-center text-lg border-2 border-dashed border-artisan-ink text-artisan-ink hover:bg-artisan-gold hover:text-white transition-colors z-20 shadow-sketch-sm cursor-pointer font-bold animate-bounce">
                                {expanded ? 'âˆ’' : '+'}
                            </div>
                        )}
                    </div>

                    {hasChildren && expanded && (
                        <>
                            {isLeafGroup ? (
                                <CompactNodeGroup nodes={node.children} level={level + 1} searchTerm={searchTerm} />
                            ) : (
                                <div className="flex flex-col items-center animate-[fadeIn_0.5s_ease-out] relative mt-4">
                                    {/* æ‰‹ç¹ªå‚ç›´é€£æ¥ç·š */}
                                    <svg className="absolute top-0 left-1/2 -translate-x-1/2 -mt-4 w-6 h-12" viewBox="0 0 24 48">
                                        <path d="M12 0 L12 48" stroke="#4A3B32" strokeWidth="2" strokeDasharray="4 2" fill="none" strokeLinecap="round" />
                                    </svg>
                                    
                                    <div className="flex relative mt-8 pt-8">
                                        {node.children.length > 1 && (
                                            // æ‰‹ç¹ªæ°´å¹³é€£æ¥ç·š
                                            <svg className="absolute top-0 left-1/2 -translate-x-1/2 w-[calc(100%-16rem)] h-6 -mt-6" viewBox="0 0 100 24" preserveAspectRatio="none">
                                                <path d="M0 12 L100 12" stroke="#4A3B32" strokeWidth="2" strokeDasharray="4 2" fill="none" strokeLinecap="round" vectorEffect="non-scaling-stroke" />
                                            </svg>
                                        )}
                                        {node.children.map((child, index) => (
                                            <div key={child.id} className="flex flex-col items-center px-4 relative">
                                                {/* æ‰‹ç¹ªå­ç¯€é»å‚ç›´é€£æ¥ç·š */}
                                                <svg className="absolute top-0 left-1/2 -translate-x-1/2 -mt-14 w-6 h-14" viewBox="0 0 24 56">
                                                    <path d="M12 0 L12 56" stroke="#4A3B32" strokeWidth="2" strokeDasharray="4 2" fill="none" strokeLinecap="round" />
                                                </svg>
                                                <OrgNode node={child} level={level + 1} searchTerm={searchTerm} />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            // Lazy initialization from localStorage
            const [csvData, setCsvData] = useState(() => {
                const saved = localStorage.getItem('mong_org_data');
                return saved || INITIAL_CSV;
            });
            const [treeData, setTreeData] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState(false);
            const [scale, setScale] = useState(1);
            const [viewMode, setViewMode] = useState('chart'); 
            const containerRef = useRef(null);
            const passwordInputRef = useRef(null);

            // Save to localStorage whenever csvData changes
            useEffect(() => {
                localStorage.setItem('mong_org_data', csvData);
            }, [csvData]);

            // Reset Function
            const handleReset = () => {
                if(confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è³‡æ–™å—ï¼Ÿé€™å°‡æœƒè¦†è“‹æ‚¨ç›®å‰çš„ä¿®æ”¹ã€‚')) {
                    setCsvData(INITIAL_CSV);
                }
            };

            useEffect(() => {
                if (window.innerWidth < 768) {
                    setViewMode('list');
                }
            }, []);

            // Robust Parser with Auto-Alignment
            const parseCSV = (csvText) => {
                try {
                    const lines = csvText.trim().split('\n');
                    const items = [];
                    let headers = [];
                    let hasExplicitHeader = false;

                    lines.forEach((line, index) => {
                        if (!line.trim()) return;
                        
                        const delimiter = line.includes('\t') ? '\t' : ',';
                        // Keep empty strings for alignment by not filtering immediately
                        let parts = line.split(delimiter).map(p => p.trim());
                        
                        // Header detection logic
                        const isHeaderRow = parts.some(p => p.toLowerCase() === 'id') && 
                                          parts.some(p => p.includes('Name') || p.includes('å¤§å') || p.includes('å§“å'));
                        
                        if (items.length === 0 && isHeaderRow) {
                           headers = parts.map(h => h.toLowerCase().replace(/\s/g, ''));
                           hasExplicitHeader = true;
                           return;
                        }
                        
                        // Default header assumption for 5 columns (matches Excel structure)
                        if (items.length === 0 && !hasExplicitHeader && !isHeaderRow) {
                            headers = ['id', 'name', 'techtitle', 'mgmttitle', 'parentid'];
                        }

                        if (parts.length < 2) return;

                        const item = {};
                        
                        const idIdx = headers.findIndex(h => h === 'id');
                        const nameIdx = headers.findIndex(h => h.includes('name') || h.includes('å'));
                        const techIdx = headers.findIndex(h => h.includes('tech') || h.includes('æŠ€è¡“') || h === 'è·ç¨±');
                        const mgmtIdx = headers.findIndex(h => h.includes('mgmt') || h.includes('ç®¡ç†')); 
                        const parentIdx = headers.findIndex(h => h.includes('parent') || h.includes('ä¸»ç®¡') || h.includes('Parent'));

                        if (idIdx !== -1 && parts[idIdx]) item.id = parts[idIdx];
                        if (nameIdx !== -1 && parts[nameIdx]) item.name = parts[nameIdx];
                        
                        item.mgmtTitle = (mgmtIdx !== -1 && parts[mgmtIdx]) ? parts[mgmtIdx] : '';
                        item.techTitle = (techIdx !== -1 && parts[techIdx]) ? parts[techIdx] : '';
                        
                        // Smart ParentID Detection
                        if (parentIdx !== -1 && parts[parentIdx]) {
                            item.parentId = parts[parentIdx];
                        } else if (parts.length >= 5) {
                            const lastVal = parts[parts.length-1];
                            if (lastVal) {
                                item.parentId = lastVal; 
                            }
                        }

                        if (!item.mgmtTitle) {
                            if (item.id && item.id.startsWith('C_')) item.mgmtTitle = 'ä¸­å¿ƒ';
                            if (item.id && item.id.startsWith('D_')) item.mgmtTitle = 'éƒ¨é–€';
                            if (item.id && item.id.startsWith('G_')) item.mgmtTitle = 'çµ„åˆ¥';
                        }

                        if (item.id && item.name) items.push(item);
                    });

                    const idMapping = items.reduce((acc, el, i) => {
                        acc[el.id] = i;
                        return acc;
                    }, {});

                    let potentialRoots = [];
                    items.forEach(el => {
                        // FIX: Detect self-reference loop (e.g. parentId == id)
                        if (el.parentId === el.id || el.parentId === el.name) {
                             console.warn("Self-reference detected, skipping parent link for:", el.name);
                             potentialRoots.push(el);
                             return;
                        }

                        if (!el.parentId || el.parentId === '') {
                            potentialRoots.push(el);
                            return;
                        }
                        
                        let parentEl = items[idMapping[el.parentId]];
                        
                        // Fallback: Find by name
                        if (!parentEl) {
                           const parentByName = items.find(i => i.name === el.parentId);
                           if (parentByName) parentEl = parentByName;
                        }

                        if (parentEl) {
                            // FIX: Cycle Detection
                            // Simple check: walk up from parent to see if we hit 'el'
                            let current = parentEl;
                            let isCycle = false;
                            let depth = 0;
                            while(current && depth < 100) { // Limit depth to prevent infinite check
                                if (current.id === el.id) {
                                    isCycle = true;
                                    break;
                                }
                                // Move up
                                if (!current.parentId) break;
                                let next = items[idMapping[current.parentId]];
                                if (!next) next = items.find(i => i.name === current.parentId);
                                current = next;
                                depth++;
                            }

                            if (isCycle) {
                                console.warn("Cycle detected for:", el.name, "->", parentEl.name);
                                potentialRoots.push(el); // Treat as root to save it
                            } else {
                                parentEl.children = [...(parentEl.children || []), el];
                            }
                        } else {
                            potentialRoots.push(el);
                        }
                    });
                    
                    const root = potentialRoots.find(r => r.id === 'CEO') || potentialRoots[0];
                    return root;

                } catch (e) {
                    console.error("Parse Error", e);
                    return null;
                }
            };

            useEffect(() => {
                const root = parseCSV(csvData);
                setTreeData(root);
            }, [csvData]);

            const handleEditClick = () => {
                if (isEditing) {
                    setIsEditing(false);
                } else {
                    setShowAuthModal(true);
                    setTimeout(() => passwordInputRef.current?.focus(), 100);
                }
            };

            const verifyPassword = (e) => {
                e.preventDefault();
                if (passwordInput === '22332525') {
                    setShowAuthModal(false);
                    setIsEditing(true);
                    setPasswordInput('');
                    setAuthError(false);
                } else {
                    setAuthError(true);
                    const input = passwordInputRef.current;
                    if (input) {
                        input.classList.add('animate-[shake_0.5s_ease-in-out]');
                        setTimeout(() => input.classList.remove('animate-[shake_0.5s_ease-in-out]'), 500);
                    }
                }
            };

            const handleZoom = (delta) => {
                setScale(prev => Math.min(Math.max(prev + delta, 0.3), 2));
            };

            return (
                <ErrorBoundary>
                    <div className="flex flex-col h-screen overflow-hidden relative font-sans text-artisan-ink">
                        {showAuthModal && <div className="absolute inset-0 z-50 flex items-center justify-center bg-artisan-ink/50 backdrop-blur-sm animate-[fadeIn_0.3s_ease-out]"><div className="bg-artisan-bg border-4 border-dashed border-artisan-ink p-8 rounded-hand shadow-sketch w-full max-w-sm relative"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-artisan-ink flex items-center gap-2 font-serif"><Icons.Lock className="w-6 h-6 text-artisan-accent" /> ç®¡ç†å“¡é©—è­‰</h3><button onClick={() => {setShowAuthModal(false); setAuthError(false); setPasswordInput('');}}><Icons.X className="w-6 h-6 text-artisan-gray" /></button></div><form onSubmit={verifyPassword}><input ref={passwordInputRef} type="password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} className={`w-full pl-4 py-3 mb-4 bg-white border-2 border-dashed rounded-lg outline-none font-bold tracking-widest text-lg ${authError ? 'border-red-500' : 'border-artisan-ink'}`} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" /><button type="submit" className="w-full bg-artisan-ink text-white py-3 rounded-lg font-bold shadow-sketch-sm hover:shadow-sketch">ç¢ºèªé€²å…¥</button></form></div></div>}
                        <div className="bg-artisan-bg/95 border-b-4 border-dashed border-artisan-ink/10 p-4 flex flex-wrap items-center justify-between z-20 gap-4 shadow-sm"><div className="flex items-center gap-4"><div className="bg-artisan-gold p-2 rounded-lg border-2 border-artisan-ink text-white shadow-sketch-sm animate-[float_6s_ease-in-out_infinite]"><Icons.Chef className="w-8 h-8" /></div><div><h1 className="text-2xl md:text-3xl font-black text-artisan-ink font-serif tracking-wide">Deafbakery</h1><p className="text-xs text-artisan-gray font-bold tracking-widest uppercase">Premium Artisan Team</p></div></div><div className="flex bg-white p-1 rounded-lg border-2 border-dashed border-artisan-ink/20"><button onClick={() => setViewMode('chart')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-bold transition-all ${viewMode === 'chart' ? 'bg-artisan-ink text-white shadow-md' : 'text-artisan-gray'}`}><Icons.Layout className="w-5 h-5" /> <span className="hidden md:inline">åœ–è¡¨</span></button><button onClick={() => setViewMode('list')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-bold transition-all ${viewMode === 'list' ? 'bg-artisan-ink text-white shadow-md' : 'text-artisan-gray'}`}><Icons.List className="w-5 h-5" /> <span className="hidden md:inline">åˆ—è¡¨</span></button></div><div className="relative flex-1 max-w-xs group"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-artisan-gray"><Icons.Search className="w-5 h-5"/></div><input type="text" placeholder="æœå°‹å¤¥ä¼´..." className="w-full pl-10 pr-4 py-2 bg-white border-2 border-dashed border-artisan-ink/20 rounded-lg outline-none font-bold shadow-sm" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div><div className="flex items-center gap-3">{viewMode === 'chart' && <div className="flex bg-white rounded-lg border-2 border-dashed border-artisan-ink/20 p-1 hidden md:flex"><button onClick={() => handleZoom(-0.1)} className="p-2 hover:text-artisan-accent"><Icons.ZoomOut className="w-5 h-5" /></button><button onClick={() => handleZoom(0.1)} className="p-2 hover:text-artisan-accent"><Icons.ZoomIn className="w-5 h-5" /></button></div>}<button onClick={handleEditClick} className={`flex items-center gap-2 px-5 py-2.5 rounded-lg font-bold transition-all border-2 border-dashed shadow-sketch-sm hover:shadow-sketch ${isEditing ? 'bg-white border-artisan-accent text-artisan-accent' : 'bg-artisan-ink border-artisan-ink text-white'}`}>{isEditing ? <Icons.X className="w-5 h-5"/> : <Icons.Edit className="w-5 h-5"/>}<span className="hidden md:inline">{isEditing ? 'é—œé–‰' : 'ç·¨è¼¯'}</span></button></div></div>
                        <div className="flex flex-1 overflow-hidden relative z-10">
                            <div className={`absolute top-0 left-0 h-full bg-artisan-cream/95 backdrop-blur-xl shadow-sketch z-40 transition-transform duration-300 flex flex-col w-full md:w-1/3 max-w-lg border-r-4 border-dashed border-artisan-ink/10 ${isEditing ? 'translate-x-0' : '-translate-x-full'}`}><div className="p-5 border-b-4 border-dashed border-artisan-ink/10 bg-artisan-bg flex justify-between items-center"><h2 className="font-bold flex items-center gap-2 text-artisan-ink text-xl"><Icons.Edit className="w-6 h-6 text-artisan-accent" /> è³‡æ–™ç¶­è­·ä¸­å¿ƒ</h2><button onClick={() => setIsEditing(false)}><Icons.X className="w-6 h-6 text-artisan-gray" /></button></div><div className="flex-1 p-6 overflow-auto flex flex-col gap-4"><div className="bg-artisan-yellow/50 p-4 rounded-lg border-2 border-dashed border-artisan-gold text-sm font-medium shadow-sm">ğŸ‘‰ ç³»çµ±æº–å‚™å°±ç·’ã€‚<br/>ğŸ‘‰ è«‹è²¼ä¸Š Excel è³‡æ–™ (Tabåˆ†éš”)ã€‚</div><textarea className="flex-1 w-full p-4 border-2 border-dashed border-artisan-ink/20 rounded-lg bg-white font-mono text-sm shadow-inner whitespace-pre" value={csvData} onChange={(e) => setCsvData(e.target.value)} spellCheck="false" /></div><div className="p-6 border-t-4 border-dashed border-artisan-ink/10 bg-artisan-bg flex gap-2"><button onClick={handleReset} className="w-1/3 bg-artisan-gray text-white py-4 rounded-lg font-bold shadow-sketch-sm hover:shadow-sketch">é‡ç½®</button><button onClick={() => setIsEditing(false)} className="w-2/3 bg-artisan-gold text-white py-4 rounded-lg font-bold shadow-sketch hover:shadow-sketch flex justify-center gap-2"><Icons.Save className="w-5 h-5"/> ç¢ºèªæ›´æ–°</button></div></div>
                            <div className="flex-1 overflow-auto relative bg-transparent" ref={containerRef}>
                                {viewMode === 'list' ? <div className="max-w-3xl mx-auto p-4 md:p-10 min-h-full"><div className="bg-white/80 backdrop-blur-sm rounded-hand border-2 border-dashed border-artisan-ink/10 p-6 shadow-sketch"><div className="pb-4 border-b-2 border-dashed border-artisan-ink/10 text-sm font-bold text-artisan-gray mb-4 flex justify-between tracking-widest uppercase"><span>Personnel List</span><span>Online</span></div>{treeData ? <ListView node={treeData} searchTerm={searchTerm} /> : <div className="p-12 text-center text-artisan-gray font-bold animate-pulse">ç„¡è³‡æ–™...</div>}</div></div> : <div className="min-w-full min-h-full relative cursor-move" onMouseDown={(e) => { const ele = containerRef.current; if (!ele) return; ele.style.cursor = 'grabbing'; ele.style.userSelect = 'none'; const startX = e.pageX - ele.offsetLeft; const startY = e.pageY - ele.offsetTop; const scrollLeft = ele.scrollLeft; const scrollTop = ele.scrollTop; const mouseMoveHandler = (e) => { const x = e.pageX - ele.offsetLeft; const y = e.pageY - ele.offsetTop; ele.scrollLeft = scrollLeft - (x - startX) * 1.5; ele.scrollTop = scrollTop - (y - startY) * 1.5; }; const mouseUpHandler = () => { ele.style.cursor = 'move'; ele.style.removeProperty('user-select'); document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseUpHandler); }; document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler); }}><div className="min-w-max min-h-max p-10 md:p-20 flex justify-center origin-top transition-transform duration-300 ease-out" style={{ transform: `scale(${scale})` }}>{treeData ? <OrgNode node={treeData} level={0} searchTerm={searchTerm} /> : <div className="text-center text-artisan-gold mt-20 font-bold text-xl animate-pulse">æ­£åœ¨ç¹ªè£½...</div>}</div></div>}
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
