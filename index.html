<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deafbakery çµ„ç¹”åœ– (é›²ç«¯ä¿®å¾©ç‰ˆ)</title>
  
  <!-- 1. å¼•å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2. å¼•å…¥ React å’Œ ReactDOM (åŠ å…¥ crossorigin ä»¥ä¿®å¾© Script Error) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  
  <!-- 3. å¼•å…¥ Babel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous"></script>

  <!-- 4. å¼•å…¥ Firebase (åŠ å…¥ crossorigin ä»¥ä¿®å¾© Script Error) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" crossorigin="anonymous"></script>
  
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    
    #error-container {
      display: none; padding: 20px; background-color: #fee2e2; color: #991b1b;
      border: 1px solid #f87171; margin: 20px; border-radius: 8px; font-family: monospace;
      white-space: pre-wrap; font-size: 14px; line-height: 1.5; z-index: 9999; position: relative;
    }
    
    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff7ed;
      display: flex; justify-content: center; align-items: center; z-index: 1000;
      color: #ea580c; font-weight: bold; transition: opacity 0.5s;
    }

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .cursor-grab { cursor: grab; }
    .cursor-grabbing { cursor: grabbing; }
  </style>
</head>
<body class="bg-orange-50 text-stone-800 font-sans overflow-hidden">
  
  <!-- è¼‰å…¥ä¸­ç•«é¢ -->
  <div id="loading">ç³»çµ±è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>

  <!-- éŒ¯èª¤é¡¯ç¤ºå€ -->
  <div id="error-container"></div>
  
  <!-- React æ ¹ç›®éŒ„ -->
  <div id="root"></div>

  <!-- éŒ¯èª¤æ•æ‰è…³æœ¬ -->
  <script>
    window.onerror = function(message, source, lineno, colno, error) {
      const container = document.getElementById('error-container');
      const loading = document.getElementById('loading');
      if(loading) loading.style.display = 'none'; // ç™¼ç”ŸéŒ¯èª¤æ™‚éš±è—è¼‰å…¥ç•«é¢
      
      container.style.display = 'block';
      const errDetail = error ? error.toString() : (typeof message === 'string' ? message : 'Unknown Error');
      container.innerHTML = '<strong>âš ï¸ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ (System Error):</strong>\n' + errDetail + '\n\nä¾†æº: ' + source + ':' + lineno + '\n\nå»ºè­°ï¼šè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šï¼Œæˆ–ç¢ºèªæª”æ¡ˆæ˜¯å¦ç‚º UTF-8 ç·¨ç¢¼ã€‚';
      console.error("Global Error Caught:", error);
    };

    // æª¢æŸ¥ä¾è³´åº«æ˜¯å¦è¼‰å…¥æˆåŠŸ
    window.onload = function() {
      const missing = [];
      if (typeof React === 'undefined') missing.push("React");
      if (typeof ReactDOM === 'undefined') missing.push("ReactDOM");
      if (typeof Babel === 'undefined') missing.push("Babel");
      
      if (missing.length > 0) {
        throw new Error("å¤–éƒ¨ç¨‹å¼åº«è¼‰å…¥å¤±æ•—: " + missing.join(", ") + "ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–é˜²ç«ç‰†è¨­å®šã€‚");
      }
    };
  </script>

  <script type="text/babel" data-presets="env,react">
    const { useState, useMemo, useEffect, useRef } = React;

    // ==========================================
    // â–¼â–¼â–¼ Firebase è¨­å®š â–¼â–¼â–¼
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyA-2_4bCv1gQWQqZ87SSgrv6M9FpiYkZhg",
      authDomain: "organization-c05dd.firebaseapp.com",
      projectId: "organization-c05dd",
      storageBucket: "organization-c05dd.firebasestorage.app",
      messagingSenderId: "864300723468",
      appId: "1:864300723468:web:b313a47ce5141d7833ad29"
    };
    // ==========================================

    // åˆå§‹åŒ– Firebase
    let db = null;
    let isCloudEnabled = false;
    try {
      if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        isCloudEnabled = true;
        console.log("Firebase initialized successfully");
      } else {
        console.warn("Firebase SDK not loaded or config missing.");
      }
    } catch (e) {
      console.error("Firebase init failed:", e);
    }

    // --- åœ–ç¤ºçµ„ä»¶ ---
    const Icon = ({ name, size = 24, className = "" }) => {
      const icons = {
        Users: <React.Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></React.Fragment>,
        User: <React.Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></React.Fragment>,
        Edit: <React.Fragment><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></React.Fragment>,
        Save: <React.Fragment><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></React.Fragment>,
        Plus: <React.Fragment><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></React.Fragment>,
        Trash2: <React.Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></React.Fragment>,
        ChevronDown: <polyline points="6 9 12 15 18 9"/>,
        ChevronRight: <polyline points="9 18 15 12 9 6"/>,
        Copy: <React.Fragment><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></React.Fragment>,
        ZoomIn: <React.Fragment><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></React.Fragment>,
        ZoomOut: <React.Fragment><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></React.Fragment>,
        Maximize: <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>,
        LayoutList: <React.Fragment><rect x="3" y="14" width="7" height="7"/><rect x="3" y="3" width="7" height="7"/><line x1="14" y1="4" x2="21" y2="4"/><line x1="14" y1="9" x2="21" y2="9"/><line x1="14" y1="15" x2="21" y2="15"/><line x1="14" y1="20" x2="21" y2="20"/></React.Fragment>,
        Network: <React.Fragment><rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3"/><path d="M12 12V8"/></React.Fragment>,
        LogIn: <React.Fragment><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></React.Fragment>,
        LogOut: <React.Fragment><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></React.Fragment>,
        Cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>,
        UploadCloud: <React.Fragment><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></React.Fragment>,
        AlertTriangle: <React.Fragment><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></React.Fragment>
      };
      return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
    };

    const INITIAL_DATA = [
      { id: "CEO", name: "æ½˜ä¿¡å®", title: "", managementTitle: "åŸ·è¡Œé•·", parentId: "" },
      { id: "COO", name: "æ½˜é‡æ©", title: "", managementTitle: "ç‡Ÿé‹é•·", parentId: "CEO" },
      { id: "C_PROD", name: "ç”Ÿç”¢ä¸­å¿ƒ", title: "", managementTitle: "", parentId: "COO" },
      { id: "C_LOGI", name: "ç‰©æµä¸­å¿ƒ", title: "", managementTitle: "", parentId: "COO" },
      { id: "C_OPS", name: "ç‡Ÿé‹ä¸­å¿ƒ", title: "", managementTitle: "", parentId: "COO" },
      { id: "C_MGM", name: "ç®¡ç†ä¸­å¿ƒ", title: "", managementTitle: "", parentId: "COO" },
      { id: "D_PROD", name: "ç”Ÿç”¢éƒ¨", title: "", managementTitle: "", parentId: "ç¾…æœˆæƒ " },
      { id: "D_PKG", name: "åŒ…è£éƒ¨", title: "", managementTitle: "", parentId: "C_PROD" },
      { id: "D_SHIP", name: "å‡ºè²¨éƒ¨", title: "", managementTitle: "", parentId: "C_LOGI" },
      { id: "D_LOGI", name: "ç‰©æµéƒ¨", title: "", managementTitle: "", parentId: "C_LOGI" },
      { id: "D_MKT", name: "è¡ŒéŠ·éƒ¨", title: "", managementTitle: "", parentId: "C_OPS" },
      { id: "D_SALES", name: "éŠ·å”®éƒ¨", title: "", managementTitle: "", parentId: "C_OPS" },
      { id: "D_CS", name: "å®¢æœéƒ¨", title: "", managementTitle: "", parentId: "C_OPS" },
      { id: "D_BD", name: "å•†å‹™æ‹“å±•éƒ¨", title: "", managementTitle: "", parentId: "C_OPS" },
      { id: "D_ADMIN", name: "ç®¡ç†éƒ¨", title: "", managementTitle: "", parentId: "C_MGM" },
      { id: "D_RD", name: "ç ”ç™¼éƒ¨", title: "", managementTitle: "", parentId: "C_PROD" },
      { id: "G_PM", name: "å°ˆæ¡ˆç®¡ç†çµ„", title: "", managementTitle: "", parentId: "é‚±å¤¢æ¶µ" },
      { id: "G_ART", name: "ç¾ç·¨çµ„", title: "", managementTitle: "", parentId: "é‚±å¤¢æ¶µ" },
      { id: "G_SNS", name: "ç¤¾ç¾¤çµ„", title: "", managementTitle: "", parentId: "é‚±å¤¢æ¶µ" },
      { id: "G_PLAN", name: "ä¼åŠƒçµ„", title: "", managementTitle: "", parentId: "é‚±å¤¢æ¶µ" },
      { id: "G_HR", name: "äººåŠ›è³‡æºçµ„", title: "", managementTitle: "", parentId: "D_ADMIN" },
      { id: "G_GA", name: "ç¸½å‹™è¡Œæ”¿çµ„", title: "", managementTitle: "", parentId: "D_ADMIN" },
      { id: "G_FIN", name: "è²¡å‹™çµ„", title: "", managementTitle: "", parentId: "D_ADMIN" },
      { id: "G_IT", name: "è³‡è¨Šç®¡ç†çµ„", title: "", managementTitle: "", parentId: "D_ADMIN" },
      { id: "G_FILL", name: "é¤¡æ–™çµ„", title: "", managementTitle: "", parentId: "D_PROD" },
      { id: "G_CUT", name: "åˆ‡å‰²çµ„", title: "", managementTitle: "", parentId: "D_PROD" },
      { id: "G_BAKE", name: "çƒ˜çƒ¤çµ„", title: "", managementTitle: "", parentId: "D_PROD" },
      { id: "ç¾…æœˆæƒ ", name: "ç¾…æœˆæƒ ", title: "", managementTitle: "ç¸½ç›£", parentId: "C_PROD" },
      { id: "å³å¤¢å©·", name: "å³å¤¢å©·", title: "", managementTitle: "ç¶“ç†", parentId: "D_BD" },
      { id: "é™³å·§çŠ", name: "é™³å·§çŠ", title: "æ¥­å‹™å°ˆå“¡", managementTitle: "", parentId: "å³å¤¢å©·" },
      { id: "é‚±å®—ä»", name: "é‚±å®—ä»", title: "ç‰©æµå°ˆå“¡", managementTitle: "è¥„ç†", parentId: "D_LOGI" },
      { id: "è¬å‘ˆå¼¦", name: "è¬å‘ˆå¼¦", title: "ç‰©æµå°ˆå“¡", managementTitle: "", parentId: "é‚±å®—ä»" },
      { id: "æå»ºèˆˆ", name: "æå»ºèˆˆ", title: "ç‰©æµå°ˆå“¡", managementTitle: "", parentId: "é‚±å®—ä»" },
      { id: "è³´éŸ‹ä»²", name: "è³´éŸ‹ä»²", title: "ç†è²¨å°ˆå“¡", managementTitle: "è¥„ç†", parentId: "D_SHIP" },
      { id: "èŠäºæ®", name: "èŠäºæ®", title: "ç†è²¨å°ˆå“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "ç¾…è™¹æ—»", name: "ç¾…è™¹æ—»", title: "ç†è²¨å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "è³´éŸ‹ä»²" },
      { id: "ç‹æƒ ç¦", name: "ç‹æƒ ç¦", title: "ç†è²¨å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "è³´éŸ‹ä»²" },
      { id: "è³´ç‘æ± ", name: "è³´ç‘æ± ", title: "ç†è²¨å°ˆå“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "å¼µç†’å€«", name: "å¼µç†’å€«", title: "ç†è²¨å“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "æ—æ·‘çª", name: "æ—æ·‘çª", title: "ç†è²¨å°ˆå“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "é™³çŸå©•", name: "é™³çŸå©•", title: "ç†è²¨å°ˆå“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "è—å¿ç¢§", name: "è—å¿ç¢§", title: "ç†è²¨å“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "é™³å·å€ª", name: "é™³å·å€ª", title: "ç†è²¨å“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "ç¾…å† ç³", name: "ç¾…å† ç³", title: "ç†è²¨å“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "è¬ç§€å¿", name: "è¬ç§€å¿", title: "ç†è²¨å“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "å¼µæ²›å«º", name: "å¼µæ²›å«º", title: "ç†è²¨å“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "é™³ç¾ä½™", name: "é™³ç¾ä½™", title: "ç†è²¨å“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "æ—ç¾æ™´", name: "æ—ç¾æ™´", title: "ç†è²¨å“¡", managementTitle: "", parentId: "è³´éŸ‹ä»²" },
      { id: "å¾ç®åº­", name: "å¾ç®åº­", title: "éŠ·å”®å°ˆå“¡", managementTitle: "å„²å‚™å¹¹éƒ¨", parentId: "é¡§åº­ç‘‹" },
      { id: "è¨±é›…æƒ ", name: "è¨±é›…æƒ ", title: "éŠ·å”®äººå“¡", managementTitle: "", parentId: "å¾ç®åº­" },
      { id: "æ½˜åè²", name: "æ½˜åè²", title: "éŠ·å”®äººå“¡", managementTitle: "", parentId: "å¾ç®åº­" },
      { id: "è•­ç¾½å©·", name: "è•­ç¾½å©·", title: "éŠ·å”®äººå“¡", managementTitle: "", parentId: "å¾ç®åº­" },
      { id: "é»ƒæƒ ç²", name: "é»ƒæƒ ç²", title: "åŒ…è£å°ˆå“¡", managementTitle: "è¥„ç†", parentId: "D_PKG" },
      { id: "è­šæ–‡ç¦", name: "è­šæ–‡ç¦", title: "åŒ…è£å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "é»ƒæƒ ç²" },
      { id: "ç›§æ€¡å®‰", name: "ç›§æ€¡å®‰", title: "åŒ…è£å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "é»ƒæƒ ç²" },
      { id: "ç‹è‹¥è“", name: "ç‹è‹¥è“", title: "åŒ…è£å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "é»ƒæƒ ç²" },
      { id: "è³´ç¾½çŠ", name: "è³´ç¾½çŠ", title: "åŒ…è£å°ˆå“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "æç¾ç²", name: "æç¾ç²", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "è”¡é›…å§", name: "è”¡é›…å§", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "æ¸¸é›…é›¯", name: "æ¸¸é›…é›¯", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "ä½•å¦‚é›", name: "ä½•å¦‚é›", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "è³´å®œè²", name: "è³´å®œè²", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "ææ¶”ç‘œ", name: "ææ¶”ç‘œ", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "æ²ˆå‚³ä»", name: "æ²ˆå‚³ä»", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "æ—å¦ç¶¸", name: "æ—å¦ç¶¸", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "åŠ‰æ˜Ÿå²‘", name: "åŠ‰æ˜Ÿå²‘", title: "åŒ…è£å“¡", managementTitle: "", parentId: "é»ƒæƒ ç²" },
      { id: "åˆ©å‰éŠ¨", name: "åˆ©å‰éŠ¨", title: "è³‡æ·±ç ”ç™¼å°ˆå“¡", managementTitle: "ç ”ç™¼ä¸»å»š", parentId: "D_RD" },
      { id: "å“ä½³è“‰", name: "å“ä½³è“‰", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "ç¾…æœˆæƒ " },
      { id: "ææ€¡çŠ", name: "ææ€¡çŠ", title: "è³‡æ·±æŠ€è¡“å°ˆå“¡", managementTitle: "", parentId: "åˆ©å‰éŠ¨" },
      { id: "è”¡å­Ÿåº­", name: "è”¡å­Ÿåº­", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "ç¾…æœˆæƒ " },
      { id: "æ›¹æŸå‡±", name: "æ›¹æŸå‡±", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "ç¾…æœˆæƒ " },
      { id: "æ´ªå­èª¼", name: "æ´ªå­èª¼", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "ç¾…æœˆæƒ " },
      { id: "åŠ‰ç¾¿å›", name: "åŠ‰ç¾¿å›", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "ç¾…æœˆæƒ " },
      { id: "é™³æµšå®", name: "é™³æµšå®", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "å» å‹™", parentId: "ç¾…æœˆæƒ " },
      { id: "é„­éœå®œ", name: "é„­éœå®œ", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "ç¾…æœˆæƒ " },
      { id: "é¾é¨„éœ‡", name: "é¾é¨„éœ‡", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "ç¾…æœˆæƒ " },
      { id: "æ±ªå»ºä½‘", name: "æ±ªå»ºä½‘", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "æŸ¯æ³³å®‰", name: "æŸ¯æ³³å®‰", title: "æŠ€è¡“å°ˆå“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "è‘‰æ–‡ç³", name: "è‘‰æ–‡ç³", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "é»ƒä½³ç¥º", name: "é»ƒä½³ç¥º", title: "ä½œæ¥­å“¡", managementTitle: "é£Ÿå®‰ç®¡ç†äººå“¡", parentId: "å“ä½³è“‰" },
      { id: "åŠ‰æ±´è±", name: "åŠ‰æ±´è±", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "å³æŸ”æ¼ª", name: "å³æŸ”æ¼ª", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "é™³éŸ»åµ", name: "é™³éŸ»åµ", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "ææ˜•åº­", name: "ææ˜•åº­", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "è‘£ä¿Šä½‘", name: "è‘£ä¿Šä½‘", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "æ±ªå»ºé”", name: "æ±ªå»ºé”", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "è”¡è© ç¿”", name: "è”¡è© ç¿”", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "è‘‰æŸå¿—", name: "è‘‰æŸå¿—", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "é»ƒå¨æ™º", name: "é»ƒå¨æ™º", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "æ—è¯è±", name: "æ—è¯è±", title: "ä½œæ¥­å“¡", managementTitle: "", parentId: "å“ä½³è“‰" },
      { id: "è•­é–å¬™", name: "è•­é–å¬™", title: "ç¾ç·¨å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "G_ART" },
      { id: "é‚±å¤¢æ¶µ", name: "é‚±å¤¢æ¶µ", title: "è³‡æ·±å°ˆæ¡ˆåŸ·è¡Œ", managementTitle: "ç¶“ç†", parentId: "D_MKT" },
      { id: "è˜‡ç¾¿ç‘„", name: "è˜‡ç¾¿ç‘„", title: "ç¤¾ç¾¤å°ˆå“¡", managementTitle: "çµ„é•·", parentId: "G_SNS" },
      { id: "è˜‡å‡Œè±", name: "è˜‡å‡Œè±", title: "å°ˆæ¡ˆåŸ·è¡Œå°ˆå“¡", managementTitle: "", parentId: "G_PM" },
      { id: "å¼µå®œå©·", name: "å¼µå®œå©·", title: "å°ˆæ¡ˆåŸ·è¡Œå°ˆå“¡", managementTitle: "", parentId: "G_PM" },
      { id: "æ´ªåƒæƒŸ", name: "æ´ªåƒæƒŸ", title: "ç¾ç·¨å°ˆå“¡", managementTitle: "", parentId: "è•­é–å¬™" },
      { id: "æ—å­£å«»", name: "æ—å­£å«»", title: "å°ˆæ¡ˆåŸ·è¡Œå°ˆå“¡", managementTitle: "", parentId: "G_PM" },
      { id: "è¨±å¯æ¦†", name: "è¨±å¯æ¦†", title: "ç¤¾ç¾¤å°ç·¨", managementTitle: "", parentId: "è˜‡ç¾¿ç‘„" },
      { id: "é™³æ¥·æ›œ", name: "é™³æ¥·æ›œ", title: "ç¤¾ç¾¤å°ç·¨", managementTitle: "", parentId: "è˜‡ç¾¿ç‘„" },
      { id: "æ›¹æ«»æ¨º", name: "æ›¹æ«»æ¨º", title: "å°ˆæ¡ˆåŸ·è¡Œå°ˆå“¡", managementTitle: "", parentId: "G_PM" },
      { id: "å¾è‹‘å¦®", name: "å¾è‹‘å¦®", title: "æœƒè¨ˆäººå“¡", managementTitle: "", parentId: "G_FIN" },
      { id: "å»–è©©æ—»", name: "å»–è©©æ—»", title: "è³‡æ·±å°ˆå“¡", managementTitle: "", parentId: "G_HR" },
      { id: "ä½•èŠ¸èŠ³", name: "ä½•èŠ¸èŠ³", title: "å°ˆå“¡", managementTitle: "", parentId: "G_HR" },
      { id: "é™³ä¿Šå‰", name: "é™³ä¿Šå‰", title: "å°ˆå“¡", managementTitle: "", parentId: "G_GA" },
      { id: "é„­é‹†æ…ˆ", name: "é„­é‹†æ…ˆ", title: "å°ˆå“¡", managementTitle: "", parentId: "G_HR" },
      { id: "è”¡è‡»å¦®", name: "è”¡è‡»å¦®", title: "å°ˆå“¡", managementTitle: "", parentId: "G_GA" },
      { id: "æ¥Šæ·¨é›¯", name: "æ¥Šæ·¨é›¯", title: "å°ˆå“¡", managementTitle: "", parentId: "G_GA" },
      { id: "æ—å–¬æ˜•", name: "æ—å–¬æ˜•", title: "å°ˆå“¡", managementTitle: "", parentId: "G_GA" },
      { id: "è³´ç‰ç ", name: "è³´ç‰ç ", title: "å°ˆå“¡", managementTitle: "", parentId: "G_GA" },
      { id: "ç‹ä½‘çŠ", name: "ç‹ä½‘çŠ", title: "å®¢æœå°ˆå“¡", managementTitle: "è¥„ç†", parentId: "D_CS" },
      { id: "æ½˜å‰é›…", name: "æ½˜å‰é›…", title: "å®¢æœå°ˆå“¡", managementTitle: "", parentId: "ç‹ä½‘çŠ" },
      { id: "æ—å§¿ç©", name: "æ—å§¿ç©", title: "å®¢æœå°ˆå“¡", managementTitle: "", parentId: "ç‹ä½‘çŠ" },
      { id: "é‚±æ…§å§", name: "é‚±æ…§å§", title: "å®¢æœå°ˆå“¡", managementTitle: "", parentId: "ç‹ä½‘çŠ" },
      { id: "æ¸¸æ˜­çª", name: "æ¸¸æ˜­çª", title: "å®¢æœå°ˆå“¡", managementTitle: "", parentId: "ç‹ä½‘çŠ" },
      { id: "é¡§åº­ç‘‹", name: "é¡§åº­ç‘‹", title: "", managementTitle: "å…¼ä»»ç¶“ç†", parentId: "D_SALES" },
      { id: "æ½˜å…¨æ©", name: "æ½˜å…¨æ©", title: "", managementTitle: "è³‡è¨Šé•·", parentId: "G_IT" },
    ];

    const buildTree = (items) => {
      const rootItems = [];
      const lookup = {};
      for (const item of items) {
        lookup[item.id] = { ...item, children: [] };
      }
      for (const item of items) {
        if (item.parentId && lookup[item.parentId]) {
          lookup[item.parentId].children.push(lookup[item.id]);
        } else {
          rootItems.push(lookup[item.id]);
        }
      }
      return rootItems;
    };

    const TreeNode = ({ node, hideTopConnector = false }) => {
      const [expanded, setExpanded] = useState(true);
      const isOrgUnit = node.id.startsWith('C_') || node.id.startsWith('D_') || node.id.startsWith('G_');
      const hasChildren = node.children.length > 0;
      const isGrid = hasChildren && node.children.length > 8;
      
      return (
        <div className={`flex flex-col items-center mx-2 ${isGrid ? 'w-full' : ''}`}>
          <div onClick={() => hasChildren && setExpanded(!expanded)} className={`relative flex flex-col items-center justify-center p-3 mb-4 rounded-lg shadow-sm border transition-all hover:shadow-md ${hasChildren ? 'cursor-pointer hover:scale-105' : 'cursor-default'} ${isOrgUnit ? 'bg-amber-100 border-amber-300 w-32 min-h-[60px]' : 'bg-white border-stone-200 w-36 min-h-[80px]'}`}>
            {!hideTopConnector && <div className="absolute -top-4 left-1/2 -translate-x-1/2 w-px h-4 bg-stone-300"></div>}
            <div className={`font-bold text-center ${isOrgUnit ? 'text-amber-900 text-lg' : 'text-stone-800 text-base'}`}>{node.name}</div>
            {!isOrgUnit && <><div className="text-xs font-medium text-orange-600 mt-1 bg-orange-50 px-2 py-0.5 rounded-full">{node.managementTitle}</div><div className="text-xs text-stone-500 mt-1 text-center">{node.title}</div></>}
            {hasChildren && <div className="absolute -bottom-2.5 left-1/2 -translate-x-1/2 w-5 h-5 bg-white border border-stone-300 rounded-full flex items-center justify-center text-stone-500 text-[10px] shadow-sm z-10">{expanded ? '-' : '+'}</div>}
          </div>
          {hasChildren && expanded && (
            <div className="flex flex-col items-center animate-fadeIn w-full">
              <div className="w-px h-4 bg-stone-300"></div>
              {isGrid ? (
                <div className="w-full pt-4 border-t-2 border-stone-300 flex justify-center">
                   <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 w-full">
                      {node.children.map(child => <div key={child.id} className="flex justify-center"><TreeNode node={child} hideTopConnector={true} /></div>)}
                   </div>
                </div>
              ) : (
                <div className="flex items-start">
                   {node.children.map((child, index) => (
                     <div key={child.id} className="flex flex-col items-center">
                       <div className="flex w-full">
                          <div className={`h-px bg-stone-300 w-[50%] ${index === 0 ? 'invisible' : ''}`}></div>
                          <div className={`h-px bg-stone-300 w-[50%] ${index === node.children.length - 1 ? 'invisible' : ''}`}></div>
                       </div>
                       <div className="w-px h-4 bg-stone-300"></div>
                       <TreeNode node={child} hideTopConnector={true} />
                     </div>
                   ))}
                </div>
              )}
            </div>
          )}
          {hasChildren && !expanded && <div className="w-px h-2 bg-stone-300 opacity-50"></div>}
        </div>
      );
    };

    const MobileTreeNode = ({ node, level = 0 }) => {
      const [isOpen, setIsOpen] = useState(true); 
      const hasChildren = node.children.length > 0;
      const isOrgUnit = node.id.startsWith('C_') || node.id.startsWith('D_') || node.id.startsWith('G_');
      return (
        <div className="w-full">
          <div className={`flex items-center p-3 border-b border-stone-100 transition-colors cursor-pointer active:bg-stone-50 ${isOrgUnit ? 'bg-amber-50' : 'bg-white'}`} style={{ paddingLeft: `${level * 16 + 12}px` }} onClick={() => hasChildren && setIsOpen(!isOpen)}>
            <div className="mr-2 text-stone-400 w-5 flex justify-center">{hasChildren ? (isOpen ? <Icon name="ChevronDown" size={16} /> : <Icon name="ChevronRight" size={16} />) : <span className="w-4" />}</div>
            <div className="flex-1"><div className="flex items-center gap-2"><span className={`font-bold ${isOrgUnit ? 'text-amber-900 text-lg' : 'text-stone-800'}`}>{node.name}</span>{!isOrgUnit && node.managementTitle && <span className="text-xs text-orange-600 bg-orange-100 px-1.5 py-0.5 rounded border border-orange-200">{node.managementTitle}</span>}</div>{!isOrgUnit && node.title && <div className="text-xs text-stone-500 mt-0.5">{node.title}</div>}</div>
          </div>
          {hasChildren && isOpen && <div className="w-full animate-fadeIn">{node.children.map(child => <MobileTreeNode key={child.id} node={child} level={level + 1} />)}</div>}
        </div>
      );
    };

    function App() {
      const [employees, setEmployees] = useState([]);
      const [isAdmin, setIsAdmin] = useState(false);
      const [password, setPassword] = useState("");
      const [showLogin, setShowLogin] = useState(false);
      const [zoom, setZoom] = useState(1);
      const [mobileViewMode, setMobileViewMode] = useState('list'); 
      const [editingId, setEditingId] = useState(null);
      const [editForm, setEditForm] = useState({});
      const scrollContainerRef = useRef(null);
      const [isDragging, setIsDragging] = useState(false);
      const [startX, setStartX] = useState(0);
      const [scrollTop, setScrollTop] = useState(0);
      const [scrollLeft, setScrollLeft] = useState(0);
      const [startY, setStartY] = useState(0);
      
      const [errorMsg, setErrorMsg] = useState(null); 

      useEffect(() => {
        if (isCloudEnabled && db) {
          const unsubscribe = db.collection('employees').onSnapshot(snapshot => {
            if (snapshot.empty) {
              setEmployees([]); 
            } else {
              const cloudData = snapshot.docs.map(doc => doc.data());
              setEmployees(cloudData);
            }
            // æˆåŠŸè¼‰å…¥å¾Œéš±è— loading
            const loading = document.getElementById('loading');
            if(loading) loading.style.opacity = '0';
            setTimeout(() => { if(loading) loading.style.display = 'none'; }, 500);
            setErrorMsg(null); 
          }, err => {
            console.error("Firestore error:", err);
            const loading = document.getElementById('loading');
            if(loading) loading.style.display = 'none';
            if (err.message.includes("Cloud Firestore API has not been used") || err.code === 'permission-denied') {
                setErrorMsg(`ğŸ”´ é›²ç«¯é€£ç·šè¢«æ‹’çµ•ï¼\nè«‹å›åˆ° Firebase Console > Firestore Database > Rules (è¦å‰‡)ï¼Œå°‡å…§å®¹æ›¿æ›ç‚ºï¼š\n\nallow read, write: if true;\n\nç„¶å¾ŒæŒ‰ç™¼å¸ƒã€‚`);
            } else {
                setErrorMsg(`âš ï¸ é€£ç·šéŒ¯èª¤: ${err.message}`);
            }
          });
          return () => unsubscribe();
        } else {
          const saved = localStorage.getItem('deafbakery_org_data');
          if (saved) {
            try {
              const parsed = JSON.parse(saved);
              setEmployees(parsed);
            } catch(e) { setEmployees(INITIAL_DATA); }
          } else {
            setEmployees(INITIAL_DATA);
          }
          const loading = document.getElementById('loading');
          if(loading) loading.style.opacity = '0';
          setTimeout(() => { if(loading) loading.style.display = 'none'; }, 500);
        }
      }, []);

      const treeData = useMemo(() => buildTree(employees), [employees]);

      const handleLogin = (e) => {
        e.preventDefault();
        if (password === '25773388') { setIsAdmin(true); setShowLogin(false); setPassword(""); } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
      };

      const handleDelete = async (id) => {
        if (!window.confirm(`ç¢ºå®šè¦åˆªé™¤ ${id} å—ï¼Ÿ`)) return;
        
        if (isCloudEnabled && db) {
          try {
            await db.collection('employees').doc(id).delete();
          } catch (e) { alert("åˆªé™¤å¤±æ•—: " + e.message); }
        } else {
          const newData = employees.filter(e => e.id !== id);
          setEmployees(newData);
          localStorage.setItem('deafbakery_org_data', JSON.stringify(newData));
        }
      };

      const handleSaveEdit = async () => {
        if (isCloudEnabled && db) {
          try {
            await db.collection('employees').doc(editForm.id).set(editForm);
            setEditingId(null);
          } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
        } else {
          const newData = employees.map(e => e.id === editingId ? editForm : e);
          setEmployees(newData);
          localStorage.setItem('deafbakery_org_data', JSON.stringify(newData));
          setEditingId(null);
          alert("å·²æš«å­˜æ–¼æœ¬æ©Ÿã€‚è‹¥è¦æ°¸ä¹…ç”Ÿæ•ˆè«‹æ›´æ–°æª”æ¡ˆæˆ–è¨­å®šé›²ç«¯ã€‚");
        }
      };

      const handleAdd = async () => {
        const newId = `NEW_${Date.now()}`;
        const newEmp = { id: newId, name: "æ–°æˆå“¡", title: "", managementTitle: "", parentId: "" };
        
        if (isCloudEnabled && db) {
          try {
            await db.collection('employees').doc(newId).set(newEmp);
            setEditingId(newId);
            setEditForm(newEmp);
          } catch (e) { alert("æ–°å¢å¤±æ•—: " + e.message); }
        } else {
          const newData = [...employees, newEmp];
          setEmployees(newData);
          localStorage.setItem('deafbakery_org_data', JSON.stringify(newData));
          setEditingId(newId);
          setEditForm(newEmp);
        }
      };

      const handleInitCloud = async () => {
        if (!isCloudEnabled || !db) return;
        if (!window.confirm("ç¢ºå®šè¦å°‡é è¨­è³‡æ–™å¯«å…¥é›²ç«¯å—ï¼Ÿé€™æœƒè¦†è“‹é›²ç«¯ç¾æœ‰è³‡æ–™ã€‚")) return;
        
        try {
          const batch = db.batch();
          INITIAL_DATA.forEach(emp => {
            const ref = db.collection('employees').doc(emp.id);
            batch.set(ref, emp);
          });
          await batch.commit();
          alert("é›²ç«¯è³‡æ–™åˆå§‹åŒ–æˆåŠŸï¼");
        } catch (e) {
          alert("åˆå§‹åŒ–å¤±æ•—: " + e.message);
        }
      };

      const handleCopyCode = () => {
        const jsonString = JSON.stringify(employees, null, 2);
        const codeString = `const INITIAL_DATA = ${jsonString};`;
        navigator.clipboard.writeText(codeString);
        alert("ç¨‹å¼ç¢¼å·²è¤‡è£½ï¼");
      };

      // Mouse Drag Events
      const onMouseDown = (e) => {
        if (!scrollContainerRef.current) return;
        setIsDragging(true);
        setStartX(e.pageX - scrollContainerRef.current.offsetLeft);
        setStartY(e.pageY - scrollContainerRef.current.offsetTop);
        setScrollLeft(scrollContainerRef.current.scrollLeft);
        setScrollTop(scrollContainerRef.current.scrollTop);
      };
      const onMouseLeave = () => setIsDragging(false);
      const onMouseUp = () => setIsDragging(false);
      const onMouseMove = (e) => {
        if (!isDragging || !scrollContainerRef.current) return;
        e.preventDefault();
        const x = e.pageX - scrollContainerRef.current.offsetLeft;
        const y = e.pageY - scrollContainerRef.current.offsetTop;
        const walkX = (x - startX) * 1.5;
        const walkY = (y - startY) * 1.5;
        scrollContainerRef.current.scrollLeft = scrollLeft - walkX;
        scrollContainerRef.current.scrollTop = scrollTop - walkY;
      };

      const handleZoomIn = () => setZoom(p => Math.min(p + 0.1, 2));
      const handleZoomOut = () => setZoom(p => Math.max(p - 0.1, 0.5));
      const handleResetZoom = () => setZoom(1);

      return (
        <div className="min-h-screen bg-orange-50 font-sans text-stone-800 flex flex-col h-screen w-full">
          
          {/* ğŸ”´ éŒ¯èª¤è¨Šæ¯æ©«å¹… */}
          {errorMsg && (
            <div className="bg-red-600 text-white px-4 py-3 shadow-md relative z-[9999] flex items-center justify-between">
              <div className="flex items-center gap-2 whitespace-pre-wrap text-sm">
                <Icon name="AlertTriangle" size={20} />
                <span>{errorMsg}</span>
              </div>
              <button onClick={() => setErrorMsg(null)} className="text-white hover:bg-red-700 p-1 rounded">âœ•</button>
            </div>
          )}

          <nav className="bg-white shadow-sm border-b border-orange-100 z-50 flex-none w-full">
            <div className="w-full px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center h-16">
                <div className="flex items-center gap-2">
                  <div className={`p-1.5 rounded-lg text-white ${isCloudEnabled ? 'bg-green-500' : 'bg-orange-500'}`}>
                    {isCloudEnabled ? <Icon name="Cloud" size={20} /> : <Icon name="Users" size={20} />}
                  </div>
                  <h1 className="text-xl font-bold tracking-tight text-stone-800">
                    Deafbakery çµ„ç¹”åœ– <span className="text-xs font-normal text-stone-400 ml-1">{isCloudEnabled ? '(é›²ç«¯é€£ç·šä¸­)' : '(å–®æ©Ÿæ¨¡å¼)'}</span>
                  </h1>
                </div>
                <button onClick={() => isAdmin ? setIsAdmin(false) : setShowLogin(true)} className={`flex items-center gap-2 px-4 py-2 rounded-full transition-all text-sm font-medium ${isAdmin ? 'bg-stone-100 text-stone-600 hover:bg-stone-200' : 'bg-stone-800 text-white hover:bg-stone-900 shadow-md hover:shadow-lg'}`}>
                  {isAdmin ? <><Icon name="LogOut" size={16} /> é€€å‡ºç·¨è¼¯</> : <><Icon name="LogIn" size={16} /> ç™»å…¥ç·¨è¼¯</>}
                </button>
              </div>
            </div>
          </nav>

          {!isAdmin && (
            <div className="lg:hidden flex border-b border-orange-100 bg-white sticky top-0 z-40">
              <button onClick={() => setMobileViewMode('list')} className={`flex-1 py-3 text-sm font-medium flex justify-center items-center gap-2 border-b-2 transition-colors ${mobileViewMode === 'list' ? 'border-orange-500 text-orange-600 bg-orange-50/50' : 'border-transparent text-stone-500'}`}><Icon name="LayoutList" size={16} /> åˆ—è¡¨æ¸…å–®</button>
              <button onClick={() => setMobileViewMode('chart')} className={`flex-1 py-3 text-sm font-medium flex justify-center items-center gap-2 border-b-2 transition-colors ${mobileViewMode === 'chart' ? 'border-orange-500 text-orange-600 bg-orange-50/50' : 'border-transparent text-stone-500'}`}><Icon name="Network" size={16} /> çµ„ç¹”åœ–è¡¨</button>
            </div>
          )}

          <main className="flex-1 overflow-hidden relative w-full">
            <div className="h-full w-full">
              {!isAdmin && (
                <React.Fragment>
                  <div className={`h-full w-full relative ${(mobileViewMode === 'chart' || window.innerWidth >= 1024) ? 'block' : 'hidden lg:block'}`}>
                    <div className="absolute bottom-6 right-6 z-30 flex flex-col gap-2 bg-white p-2 rounded-lg shadow-lg border border-stone-200">
                      <button onClick={handleZoomIn} className="p-2 hover:bg-stone-100 rounded text-stone-600"><Icon name="ZoomIn" size={20} /></button>
                      <button onClick={handleZoomOut} className="p-2 hover:bg-stone-100 rounded text-stone-600"><Icon name="ZoomOut" size={20} /></button>
                      <button onClick={handleResetZoom} className="p-2 hover:bg-stone-100 rounded text-stone-600"><Icon name="Maximize" size={20} /></button>
                      <div className="text-center text-xs text-stone-400 border-t pt-1 mt-1 font-mono">{Math.round(zoom * 100)}%</div>
                    </div>
                    <div ref={scrollContainerRef} className={`h-full w-full overflow-auto bg-stone-50 p-10 scrollbar-hide ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`} onMouseDown={onMouseDown} onMouseLeave={onMouseLeave} onMouseUp={onMouseUp} onMouseMove={onMouseMove}>
                       <div className="min-w-max min-h-max origin-top" style={{ transform: `scale(${zoom})`, transformOrigin: 'top center' }}>
                          <div className="flex justify-center pb-20">{treeData.map(node => <TreeNode key={node.id} node={node} />)}</div>
                       </div>
                    </div>
                  </div>
                  <div className={`h-full overflow-y-auto bg-white ${mobileViewMode === 'list' ? 'block lg:hidden' : 'hidden'}`}>
                     <div className="p-4 bg-orange-100 text-orange-800 text-sm font-medium border-b border-orange-200 sticky top-0 z-10">é»æ“Šé …ç›®å¯å±•é–‹/æ”¶åˆéƒ¨é–€</div>
                     {treeData.map(node => <MobileTreeNode key={node.id} node={node} />)}
                     <div className="p-8 text-center text-sm text-stone-400">Designed for Deafbakery</div>
                  </div>
                </React.Fragment>
              )}

              {isAdmin && (
                <div className="h-full overflow-y-auto p-4 w-full">
                  <div className="bg-white rounded-xl shadow border border-stone-200 p-6 animate-fadeIn mb-8 max-w-7xl mx-auto">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                      <div>
                        <h2 className="text-2xl font-bold text-stone-800 flex items-center gap-2"><Icon name="Edit" size={24} className="text-orange-500" /> è³‡æ–™ç·¨è¼¯æ¨¡å¼ ({isCloudEnabled ? "é›²ç«¯" : "å–®æ©Ÿ"})</h2>
                        <p className="text-stone-500 text-sm mt-1">{isCloudEnabled ? "âœ… å·²é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«ï¼Œæ‚¨çš„ä¿®æ”¹æœƒå³æ™‚è‡ªå‹•å„²å­˜ä¸¦åŒæ­¥çµ¦æ‰€æœ‰äººã€‚" : "âš ï¸ ç›®å‰ç‚ºå–®æ©Ÿæ¨¡å¼ï¼Œä¿®æ”¹åƒ…æš«å­˜æ–¼æ­¤é›»è…¦ã€‚è«‹å¡«å…¥ Firebase è¨­å®šä»¥å•Ÿç”¨é›²ç«¯åŠŸèƒ½ã€‚"}</p>
                      </div>
                      <div className="flex gap-2">
                        {isCloudEnabled && employees.length === 0 && (
                          <button onClick={handleInitCloud} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-sm">
                            <Icon name="UploadCloud" size={18} /> åˆå§‹åŒ–é›²ç«¯è³‡æ–™
                          </button>
                        )}
                        <button onClick={handleAdd} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors shadow-sm"><Icon name="Plus" size={18} /> æ–°å¢äººå“¡</button>
                        {!isCloudEnabled && (
                          <button onClick={handleCopyCode} className="flex items-center gap-2 bg-stone-800 hover:bg-stone-900 text-white px-4 py-2 rounded-lg transition-colors shadow-sm"><Icon name="Copy" size={18} /> è¤‡è£½ç¨‹å¼ç¢¼</button>
                        )}
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm text-stone-600">
                        <thead className="bg-stone-50 text-stone-800 uppercase font-medium">
                          <tr><th className="p-3 rounded-tl-lg">ID</th><th className="p-3">å§“å (Name)</th><th className="p-3">æŠ€è¡“è·ç¨±</th><th className="p-3">ç®¡ç†è·ç¨±</th><th className="p-3">Parent ID (ä¸Šç´š)</th><th className="p-3 rounded-tr-lg text-right">æ“ä½œ</th></tr>
                        </thead>
                        <tbody className="divide-y divide-stone-100">
                          {employees.map(emp => (
                            <tr key={emp.id} className="hover:bg-orange-50 transition-colors">
                              {editingId === emp.id ? (
                                <React.Fragment>
                                  <td className="p-2"><input className="w-full p-1 border rounded" value={editForm.id} onChange={e => setEditForm({...editForm, id: e.target.value})} /></td>
                                  <td className="p-2"><input className="w-full p-1 border rounded" value={editForm.name} onChange={e => setEditForm({...editForm, name: e.target.value})} /></td>
                                  <td className="p-2"><input className="w-full p-1 border rounded" value={editForm.title} onChange={e => setEditForm({...editForm, title: e.target.value})} /></td>
                                  <td className="p-2"><input className="w-full p-1 border rounded" value={editForm.managementTitle} onChange={e => setEditForm({...editForm, managementTitle: e.target.value})} /></td>
                                  <td className="p-2"><input className="w-full p-1 border rounded" value={editForm.parentId} onChange={e => setEditForm({...editForm, parentId: e.target.value})} /></td>
                                  <td className="p-2 text-right">
                                    <button onClick={handleSaveEdit} className="text-green-600 hover:text-green-800 mr-2"><Icon name="Save" size={18}/></button>
                                    <button onClick={() => setEditingId(null)} className="text-stone-400 hover:text-stone-600">å–æ¶ˆ</button>
                                  </td>
                                </React.Fragment>
                              ) : (
                                <React.Fragment>
                                  <td className="p-3 font-mono text-xs">{emp.id}</td>
                                  <td className="p-3 font-bold text-stone-800">{emp.name}</td>
                                  <td className="p-3">{emp.title}</td>
                                  <td className="p-3 text-orange-600">{emp.managementTitle}</td>
                                  <td className="p-3 font-mono text-xs text-stone-400">{emp.parentId}</td>
                                  <td className="p-3 text-right">
                                    <button onClick={() => handleEdit(emp)} className="text-blue-500 hover:text-blue-700 mr-3"><Icon name="Edit" size={18}/></button>
                                    <button onClick={() => handleDelete(emp.id)} className="text-red-400 hover:text-red-600"><Icon name="Trash2" size={18}/></button>
                                  </td>
                                </React.Fragment>
                              )}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </main>
          {showLogin && (
            <div className="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm animate-scaleIn">
                <h3 className="text-lg font-bold text-stone-800 mb-4">ç®¡ç†å“¡ç™»å…¥</h3>
                <form onSubmit={handleLogin}>
                  <input type="password" placeholder="è¼¸å…¥å¯†ç¢¼" className="w-full p-3 border border-stone-200 rounded-lg mb-4 focus:ring-2 focus:ring-orange-300 outline-none transition-all" value={password} onChange={e => setPassword(e.target.value)} autoFocus />
                  <div className="flex gap-2">
                    <button type="submit" className="flex-1 bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition-colors">ç™»å…¥</button>
                    <button type="button" onClick={() => setShowLogin(false)} className="flex-1 bg-stone-100 text-stone-600 py-2 rounded-lg hover:bg-stone-200 transition-colors">å–æ¶ˆ</button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
