<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deafbakery 組織圖 (雲端版)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" crossorigin="anonymous"></script>
  
  <style>
    body { background-color: #fff7ed; color: #44403c; font-family: sans-serif; overflow: hidden; }
    #error-container { display: none; padding: 20px; background: #fee2e2; color: #991b1b; border-bottom: 1px solid #f87171; position: fixed; top: 0; left: 0; width: 100%; z-index: 10000; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff7ed; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 5000; font-size: 1.2rem; color: #ea580c; transition: opacity 0.5s; }
    .loading-text { margin-top: 10px; font-size: 0.9rem; color: #78716c; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .cursor-grab { cursor: grab; }
    .cursor-grabbing { cursor: grabbing; }
  </style>
</head>
<body>
  <div id="error-container"></div>
  <div id="loading">
    <div>正在連線至雲端系統...</div>
    <div class="loading-text">若超過 5 秒未回應，將自動切換為單機模式</div>
  </div>
  <div id="root"></div>

  <script>
    // 全域錯誤處理
    window.onerror = function(msg, src, line, col, error) {
      document.getElementById('loading').style.display = 'none';
      const el = document.getElementById('error-container');
      el.style.display = 'block';
      el.innerHTML = '<strong>⚠️ 系統錯誤 (System Error):</strong><br>' + msg + '<br><small>來源: ' + src + ':' + line + '</small>';
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // --- Firebase 設定 ---
    const firebaseConfig = {
      apiKey: "AIzaSyA-2_4bCv1gQWQqZ87SSgrv6M9FpiYkZhg",
      authDomain: "organization-c05dd.firebaseapp.com",
      projectId: "organization-c05dd",
      storageBucket: "organization-c05dd.firebasestorage.app",
      messagingSenderId: "864300723468",
      appId: "1:864300723468:web:b313a47ce5141d7833ad29"
    };

    let db = null;
    let isCloud = false;
    try {
      if (typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        isCloud = true;
      }
    } catch (e) { console.error("Firebase init error:", e); }

    // --- 簡單圖示組件 ---
    const Icon = ({ name }) => {
      const p = {
        Users: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75",
        ZoomIn: "M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M21 21l-4.35-4.35 M11 8v6 M8 11h6",
        ZoomOut: "M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M21 21l-4.35-4.35 M8 11h6",
        Cloud: "M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z",
        Edit: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z",
        Save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z M17 21l0-8-10 0 0 8 M7 3l0 5 8 0",
        Plus: "M12 5v14 M5 12h14",
        Trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6 M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
        Right: "M9 18l6-6-6-6",
        Down: "M6 9l6 6 6-6"
      };
      return <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d={p[name] || "M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"} strokeLinecap="round" strokeLinejoin="round"/></svg>;
    };

    // --- 預設資料 ---
    const INITIAL_DATA = [
      { id: "CEO", name: "潘信宏", title: "", managementTitle: "執行長", parentId: "" },
      { id: "COO", name: "潘重恩", title: "", managementTitle: "營運長", parentId: "CEO" },
      { id: "C_PROD", name: "生產中心", title: "", managementTitle: "", parentId: "COO" },
      { id: "C_LOGI", name: "物流中心", title: "", managementTitle: "", parentId: "COO" },
      { id: "C_OPS", name: "營運中心", title: "", managementTitle: "", parentId: "COO" },
      { id: "C_MGM", name: "管理中心", title: "", managementTitle: "", parentId: "COO" },
      { id: "D_PROD", name: "生產部", title: "", managementTitle: "", parentId: "羅月惠" },
      { id: "D_PKG", name: "包裝部", title: "", managementTitle: "", parentId: "C_PROD" },
      { id: "D_SHIP", name: "出貨部", title: "", managementTitle: "", parentId: "C_LOGI" },
      { id: "D_LOGI", name: "物流部", title: "", managementTitle: "", parentId: "C_LOGI" },
      { id: "D_MKT", name: "行銷部", title: "", managementTitle: "", parentId: "C_OPS" },
      { id: "D_SALES", name: "銷售部", title: "", managementTitle: "", parentId: "C_OPS" },
      { id: "D_CS", name: "客服部", title: "", managementTitle: "", parentId: "C_OPS" },
      { id: "D_BD", name: "商務拓展部", title: "", managementTitle: "", parentId: "C_OPS" },
      { id: "D_ADMIN", name: "管理部", title: "", managementTitle: "", parentId: "C_MGM" },
      { id: "D_RD", name: "研發部", title: "", managementTitle: "", parentId: "C_PROD" },
      { id: "G_PM", name: "專案管理組", title: "", managementTitle: "", parentId: "邱夢涵" },
      { id: "G_ART", name: "美編組", title: "", managementTitle: "", parentId: "邱夢涵" },
      { id: "G_SNS", name: "社群組", title: "", managementTitle: "", parentId: "邱夢涵" },
      { id: "G_PLAN", name: "企劃組", title: "", managementTitle: "", parentId: "邱夢涵" },
      { id: "G_HR", name: "人力資源組", title: "", managementTitle: "", parentId: "D_ADMIN" },
      { id: "G_GA", name: "總務行政組", title: "", managementTitle: "", parentId: "D_ADMIN" },
      { id: "G_FIN", name: "財務組", title: "", managementTitle: "", parentId: "D_ADMIN" },
      { id: "G_IT", name: "資訊管理組", title: "", managementTitle: "", parentId: "D_ADMIN" },
      { id: "G_FILL", name: "餡料組", title: "", managementTitle: "", parentId: "D_PROD" },
      { id: "G_CUT", name: "切割組", title: "", managementTitle: "", parentId: "D_PROD" },
      { id: "G_BAKE", name: "烘烤組", title: "", managementTitle: "", parentId: "D_PROD" },
      { id: "羅月惠", name: "羅月惠", title: "", managementTitle: "總監", parentId: "C_PROD" },
      { id: "吳夢婷", name: "吳夢婷", title: "", managementTitle: "經理", parentId: "D_BD" },
      { id: "陳巧珊", name: "陳巧珊", title: "業務專員", managementTitle: "", parentId: "吳夢婷" },
      { id: "邱宗仁", name: "邱宗仁", title: "物流專員", managementTitle: "襄理", parentId: "D_LOGI" },
      { id: "謝呈弦", name: "謝呈弦", title: "物流專員", managementTitle: "", parentId: "邱宗仁" },
      { id: "李建興", name: "李建興", title: "物流專員", managementTitle: "", parentId: "邱宗仁" },
      { id: "賴韋仲", name: "賴韋仲", title: "理貨專員", managementTitle: "襄理", parentId: "D_SHIP" },
      { id: "莊于揮", name: "莊于揮", title: "理貨專員", managementTitle: "", parentId: "賴韋仲" },
      { id: "羅虹旻", name: "羅虹旻", title: "理貨專員", managementTitle: "組長", parentId: "賴韋仲" },
      { id: "王惠琦", name: "王惠琦", title: "理貨專員", managementTitle: "組長", parentId: "賴韋仲" },
      { id: "賴瑞池", name: "賴瑞池", title: "理貨專員", managementTitle: "", parentId: "賴韋仲" },
      { id: "張熒倫", name: "張熒倫", title: "理貨員", managementTitle: "", parentId: "賴韋仲" },
      { id: "林淑琪", name: "林淑琪", title: "理貨專員", managementTitle: "", parentId: "賴韋仲" },
      { id: "陳玟婕", name: "陳玟婕", title: "理貨專員", managementTitle: "", parentId: "賴韋仲" },
      { id: "藍卿碧", name: "藍卿碧", title: "理貨員", managementTitle: "", parentId: "賴韋仲" },
      { id: "陳川倪", name: "陳川倪", title: "理貨員", managementTitle: "", parentId: "賴韋仲" },
      { id: "羅冠琳", name: "羅冠琳", title: "理貨員", managementTitle: "", parentId: "賴韋仲" },
      { id: "謝秀卿", name: "謝秀卿", title: "理貨員", managementTitle: "", parentId: "賴韋仲" },
      { id: "張沛嫺", name: "張沛嫺", title: "理貨員", managementTitle: "", parentId: "賴韋仲" },
      { id: "陳美余", name: "陳美余", title: "理貨員", managementTitle: "", parentId: "賴韋仲" },
      { id: "林美晴", name: "林美晴", title: "理貨員", managementTitle: "", parentId: "賴韋仲" },
      { id: "徐珮庭", name: "徐珮庭", title: "銷售專員", managementTitle: "儲備幹部", parentId: "顧庭瑋" },
      { id: "許雅惠", name: "許雅惠", title: "銷售人員", managementTitle: "", parentId: "徐珮庭" },
      { id: "潘名貞", name: "潘名貞", title: "銷售人員", managementTitle: "", parentId: "徐珮庭" },
      { id: "蕭羽婷", name: "蕭羽婷", title: "銷售人員", managementTitle: "", parentId: "徐珮庭" },
      { id: "黃惠玲", name: "黃惠玲", title: "包裝專員", managementTitle: "襄理", parentId: "D_PKG" },
      { id: "譚文琦", name: "譚文琦", title: "包裝專員", managementTitle: "組長", parentId: "黃惠玲" },
      { id: "盧怡安", name: "盧怡安", title: "包裝專員", managementTitle: "組長", parentId: "黃惠玲" },
      { id: "王若蓁", name: "王若蓁", title: "包裝專員", managementTitle: "組長", parentId: "黃惠玲" },
      { id: "賴羽珊", name: "賴羽珊", title: "包裝專員", managementTitle: "", parentId: "黃惠玲" },
      { id: "李美玲", name: "李美玲", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "蔡雅姍", name: "蔡雅姍", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "游雅雯", name: "游雅雯", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "何如雁", name: "何如雁", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "賴宜貞", name: "賴宜貞", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "李涔瑜", name: "李涔瑜", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "沈傳仁", name: "沈傳仁", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "林妍綸", name: "林妍綸", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "劉星岑", name: "劉星岑", title: "包裝員", managementTitle: "", parentId: "黃惠玲" },
      { id: "利偉銨", name: "利偉銨", title: "資深研發專員", managementTitle: "研發主廚", parentId: "D_RD" },
      { id: "卓佳蓉", name: "卓佳蓉", title: "技術專員", managementTitle: "組長", parentId: "羅月惠" },
      { id: "李怡珊", name: "李怡珊", title: "資深技術專員", managementTitle: "", parentId: "利偉銨" },
      { id: "蔡孟庭", name: "蔡孟庭", title: "技術專員", managementTitle: "組長", parentId: "羅月惠" },
      { id: "曹柏凱", name: "曹柏凱", title: "技術專員", managementTitle: "組長", parentId: "羅月惠" },
      { id: "洪孝誼", name: "洪孝誼", title: "技術專員", managementTitle: "組長", parentId: "羅月惠" },
      { id: "劉羿君", name: "劉羿君", title: "技術專員", managementTitle: "組長", parentId: "羅月惠" },
      { id: "陳浚宏", name: "陳浚宏", title: "技術專員", managementTitle: "廠務", parentId: "羅月惠" },
      { id: "鄭靜宜", name: "鄭靜宜", title: "技術專員", managementTitle: "組長", parentId: "羅月惠" },
      { id: "鍾騄震", name: "鍾騄震", title: "技術專員", managementTitle: "組長", parentId: "羅月惠" },
      { id: "汪建佑", name: "汪建佑", title: "技術專員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "柯泳安", name: "柯泳安", title: "技術專員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "葉文琳", name: "葉文琳", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "黃佳祺", name: "黃佳祺", title: "作業員", managementTitle: "食安管理人員", parentId: "卓佳蓉" },
      { id: "劉汴萱", name: "劉汴萱", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "吳柔漪", name: "吳柔漪", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "陳韻嵐", name: "陳韻嵐", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "李昕庭", name: "李昕庭", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "董俊佑", name: "董俊佑", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "汪建達", name: "汪建達", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "蔡詠翔", name: "蔡詠翔", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "葉柏志", name: "葉柏志", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "黃威智", name: "黃威智", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "林華萱", name: "林華萱", title: "作業員", managementTitle: "", parentId: "卓佳蓉" },
      { id: "蕭靖嬙", name: "蕭靖嬙", title: "美編專員", managementTitle: "組長", parentId: "G_ART" },
      { id: "邱夢涵", name: "邱夢涵", title: "資深專案執行", managementTitle: "經理", parentId: "D_MKT" },
      { id: "蘇羿瑄", name: "蘇羿瑄", title: "社群專員", managementTitle: "組長", parentId: "G_SNS" },
      { id: "蘇凌萱", name: "蘇凌萱", title: "專案執行專員", managementTitle: "", parentId: "G_PM" },
      { id: "張宜婷", name: "張宜婷", title: "專案執行專員", managementTitle: "", parentId: "G_PM" },
      { id: "洪千惟", name: "洪千惟", title: "美編專員", managementTitle: "", parentId: "蕭靖嬙" },
      { id: "林季嫻", name: "林季嫻", title: "專案執行專員", managementTitle: "", parentId: "G_PM" },
      { id: "許可榆", name: "許可榆", title: "社群小編", managementTitle: "", parentId: "蘇羿瑄" },
      { id: "陳楷曜", name: "陳楷曜", title: "社群小編", managementTitle: "", parentId: "蘇羿瑄" },
      { id: "曹櫻樺", name: "曹櫻樺", title: "專案執行專員", managementTitle: "", parentId: "G_PM" },
      { id: "徐苑妮", name: "徐苑妮", title: "會計人員", managementTitle: "", parentId: "G_FIN" },
      { id: "廖詩旻", name: "廖詩旻", title: "資深專員", managementTitle: "", parentId: "G_HR" },
      { id: "何芸芳", name: "何芸芳", title: "專員", managementTitle: "", parentId: "G_HR" },
      { id: "陳俊吉", name: "陳俊吉", title: "專員", managementTitle: "", parentId: "G_GA" },
      { id: "鄭鋆慈", name: "鄭鋆慈", title: "專員", managementTitle: "", parentId: "G_HR" },
      { id: "蔡臻妮", name: "蔡臻妮", title: "專員", managementTitle: "", parentId: "G_GA" },
      { id: "楊淨雯", name: "楊淨雯", title: "專員", managementTitle: "", parentId: "G_GA" },
      { id: "林喬昕", name: "林喬昕", title: "專員", managementTitle: "", parentId: "G_GA" },
      { id: "賴玉珠", name: "賴玉珠", title: "專員", managementTitle: "", parentId: "G_GA" },
      { id: "王佑珊", name: "王佑珊", title: "客服專員", managementTitle: "襄理", parentId: "D_CS" },
      { id: "潘卉雅", name: "潘卉雅", title: "客服專員", managementTitle: "", parentId: "王佑珊" },
      { id: "林姿穎", name: "林姿穎", title: "客服專員", managementTitle: "", parentId: "王佑珊" },
      { id: "邱慧姍", name: "邱慧姍", title: "客服專員", managementTitle: "", parentId: "王佑珊" },
      { id: "游昭琪", name: "游昭琪", title: "客服專員", managementTitle: "", parentId: "王佑珊" },
      { id: "顧庭瑋", name: "顧庭瑋", title: "", managementTitle: "兼任經理", parentId: "D_SALES" },
      { id: "潘全恩", name: "潘全恩", title: "", managementTitle: "資訊長", parentId: "G_IT" },
    ];

    // --- 邏輯組件 ---
    function App() {
      const [data, setData] = useState([]);
      const [isAdmin, setIsAdmin] = useState(false);
      const [loginShow, setLoginShow] = useState(false);
      const [pwd, setPwd] = useState("");
      const [zoom, setZoom] = useState(1);
      const [isMobile, setIsMobile] = useState(window.innerWidth < 1024);
      const [viewMode, setViewMode] = useState('list'); // 'list' or 'chart'
      
      const scrollRef = useRef();
      const [drag, setDrag] = useState({ isDown: false, startX: 0, startY: 0, scrollLeft: 0, scrollTop: 0 });

      // 監聽視窗大小
      useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      // 資料載入
      useEffect(() => {
        // --- 連線逾時保護 ---
        const timeoutId = setTimeout(() => {
          const loadingEl = document.getElementById('loading');
          if (loadingEl && loadingEl.style.display !== 'none') {
            loadingEl.style.display = 'none';
            if (data.length === 0) {
              // 逾時沒載入到資料，切換單機並載入預設
              console.warn("Firebase timeout, using local data.");
              setData(INITIAL_DATA); 
              const errEl = document.getElementById('error-container');
              errEl.style.display = 'block';
              errEl.innerHTML = '<strong>⚠️ 連線逾時:</strong> 已自動切換為離線模式 (資料無法同步雲端)。';
            }
          }
        }, 5000); // 5秒

        if (isCloud && db) {
          const unsub = db.collection('employees').onSnapshot(snap => {
            clearTimeout(timeoutId); // 成功連線，取消逾時警告
            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => {
                const el = document.getElementById('loading');
                if(el) el.style.display = 'none';
            }, 500);
            
            if (snap.empty) {
              setData([]);
            } else {
              const list = [];
              snap.forEach(doc => list.push(doc.data()));
              setData(list);
            }
          }, err => {
            console.error("Firestore Error:", err);
            clearTimeout(timeoutId);
            document.getElementById('loading').style.display = 'none';
            const errEl = document.getElementById('error-container');
            errEl.style.display = 'block';
            if(err.code === 'permission-denied') {
              errEl.innerHTML = '<strong>⛔ 權限不足:</strong> 請至 Firebase Console > Firestore > Rules 設定規則為 <code>allow read, write: if true;</code>';
            } else {
              errEl.innerHTML = '<strong>⚠️ 連線錯誤:</strong> ' + err.message;
            }
            // 發生錯誤時載入預設資料讓使用者能看
            setData(INITIAL_DATA);
          });
          return () => unsub();
        } else {
          // 單機模式
          clearTimeout(timeoutId);
          document.getElementById('loading').style.display = 'none';
          const saved = localStorage.getItem('deafbakery_org_data');
          if (saved) {
            try { setData(JSON.parse(saved)); } catch(e) { setData(INITIAL_DATA); }
          } else {
            setData(INITIAL_DATA);
          }
        }
      }, []);

      const tree = useMemo(() => {
        const map = {}, roots = [];
        data.forEach(d => map[d.id] = { ...d, children: [] });
        data.forEach(d => {
          if (d.parentId && map[d.parentId]) map[d.parentId].children.push(map[d.id]);
          else roots.push(map[d.id]);
        });
        return roots;
      }, [data]);

      // 拖曳邏輯
      const onMouseDown = e => {
        if (!scrollRef.current) return;
        setDrag({ isDown: true, startX: e.pageX - scrollRef.current.offsetLeft, startY: e.pageY - scrollRef.current.offsetTop, scrollLeft: scrollRef.current.scrollLeft, scrollTop: scrollRef.current.scrollTop });
      };
      const onMouseLeave = () => setDrag({ ...drag, isDown: false });
      const onMouseUp = () => setDrag({ ...drag, isDown: false });
      const onMouseMove = e => {
        if (!drag.isDown) return;
        e.preventDefault();
        const x = e.pageX - scrollRef.current.offsetLeft;
        const y = e.pageY - scrollRef.current.offsetTop;
        scrollRef.current.scrollLeft = drag.scrollLeft - (x - drag.startX) * 1.5;
        scrollRef.current.scrollTop = drag.scrollTop - (y - drag.startY) * 1.5;
      };

      // 編輯功能
      const [editId, setEditId] = useState(null);
      const [form, setForm] = useState({});

      const handleSave = async () => {
        if(isCloud && db) {
          try {
            await db.collection('employees').doc(form.id).set(form);
            setEditId(null);
          } catch(e) { alert("儲存失敗: " + e.message); }
        } else {
          alert("單機模式：變更已存於本機暫存區。");
          const newData = data.map(d => d.id === form.id ? form : d);
          setData(newData);
          localStorage.setItem('deafbakery_org_data', JSON.stringify(newData));
          setEditId(null);
        }
      };

      const handleDel = async (id) => {
        if(!confirm("確定刪除?")) return;
        if(isCloud && db) {
          try { await db.collection('employees').doc(id).delete(); } catch(e) { alert("刪除失敗"); }
        } else {
          const newData = data.filter(d => d.id !== id);
          setData(newData);
          localStorage.setItem('deafbakery_org_data', JSON.stringify(newData));
        }
      };

      const handleAdd = async () => {
        const id = "NEW_" + Date.now();
        const newItem = { id, name: "新成員", title: "", managementTitle: "", parentId: "" };
        if(isCloud && db) {
          await db.collection('employees').doc(id).set(newItem);
          setEditId(id); setForm(newItem);
        } else {
          const newData = [...data, newItem];
          setData(newData);
          localStorage.setItem('deafbakery_org_data', JSON.stringify(newData));
          setEditId(id); setForm(newItem);
        }
      };

      // 雲端初始化
      const initCloud = async () => {
        if(!confirm("確定要將預設資料寫入雲端嗎?")) return;
        const batch = db.batch();
        INITIAL_DATA.forEach(d => batch.set(db.collection('employees').doc(d.id), d));
        await batch.commit();
        alert("初始化完成");
      };

      // 渲染節點
      const Node = ({ node, isRoot }) => {
        const [open, setOpen] = useState(true);
        const isOrg = node.id.startsWith("C_") || node.id.startsWith("D_") || node.id.startsWith("G_");
        const isGrid = node.children.length > 8; // 自動矩陣

        return (
          <div className={`flex flex-col items-center mx-2 ${isGrid?'w-full':''}`}>
            <div 
              onClick={() => setOpen(!open)}
              className={`relative flex flex-col items-center justify-center p-2 mb-4 rounded shadow border cursor-pointer hover:shadow-md transition-all ${isOrg ? 'bg-amber-100 border-amber-300 w-32 min-h-[60px]' : 'bg-white border-stone-200 w-36 min-h-[80px]'}`}
            >
              {!isRoot && <div className="absolute -top-4 w-px h-4 bg-stone-300"></div>}
              <div className={`font-bold text-center ${isOrg ? 'text-amber-900' : 'text-stone-800'}`}>{node.name}</div>
              {!isOrg && <><div className="text-xs text-orange-600 bg-orange-50 px-2 py-0.5 rounded mt-1">{node.managementTitle}</div><div className="text-xs text-stone-500">{node.title}</div></>}
              {node.children.length > 0 && <div className="absolute -bottom-2 w-4 h-4 bg-white border rounded-full flex items-center justify-center text-[10px]">{open ? '-' : '+'}</div>}
            </div>
            
            {node.children.length > 0 && open && (
              <div className="flex flex-col items-center w-full animate-fadeIn">
                <div className="w-px h-4 bg-stone-300"></div>
                {isGrid ? (
                  <div className="border-t-2 border-stone-300 pt-4 flex justify-center w-full">
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
                      {node.children.map(c => <div key={c.id} className="flex justify-center"><Node node={c} /></div>)}
                    </div>
                  </div>
                ) : (
                  <div className="flex items-start">
                    {node.children.map((c, i) => (
                      <div key={c.id} className="flex flex-col items-center">
                        <div className="flex w-full">
                          <div className={`h-px bg-stone-300 w-1/2 ${i===0?'invisible':''}`}></div>
                          <div className={`h-px bg-stone-300 w-1/2 ${i===node.children.length-1?'invisible':''}`}></div>
                        </div>
                        <div className="w-px h-4 bg-stone-300"></div>
                        <Node node={c} />
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        );
      };

      // 手機列表渲染
      const MobileNode = ({ node, lv = 0 }) => {
        const [open, setOpen] = useState(false);
        const hasChild = node.children.length > 0;
        return (
          <div className="w-full border-b border-stone-100">
            <div className="flex items-center p-3" style={{paddingLeft: 12 + lv*16}} onClick={() => setOpen(!open)}>
              <div className="w-6 text-stone-400">{hasChild && (open ? <Icon name="Down"/> : <Icon name="Right"/>)}</div>
              <div><div className="font-bold text-stone-800">{node.name} <span className="text-xs text-orange-600 font-normal">{node.managementTitle}</span></div></div>
            </div>
            {hasChild && open && <div>{node.children.map(c => <MobileNode key={c.id} node={c} lv={lv+1}/>)}</div>}
          </div>
        );
      };

      return (
        <div className="flex flex-col h-screen w-full">
          <nav className="bg-white shadow z-10 flex justify-between items-center px-4 h-16 shrink-0">
            <div className="flex items-center gap-2 font-bold text-lg text-stone-800">
              <div className={`p-1 rounded text-white ${isCloud ? 'bg-green-500':'bg-orange-500'}`}><Icon name={isCloud?"Cloud":"Users"}/></div>
              Deafbakery {isCloud && <span className="text-xs font-normal text-green-600 bg-green-50 px-2 rounded-full">雲端版</span>}
            </div>
            <button onClick={() => isAdmin ? setIsAdmin(false) : setLoginShow(true)} className="text-sm px-3 py-1 bg-stone-100 rounded hover:bg-stone-200">
              {isAdmin ? "退出" : "編輯"}
            </button>
          </nav>

          {/* 手機版切換按鈕 */}
          {isMobile && !isAdmin && (
            <div className="flex border-b bg-white shrink-0">
              <button onClick={()=>setViewMode('list')} className={`flex-1 py-2 text-center ${viewMode==='list'?'text-orange-600 border-b-2 border-orange-600':''}`}>列表</button>
              <button onClick={()=>setViewMode('chart')} className={`flex-1 py-2 text-center ${viewMode==='chart'?'text-orange-600 border-b-2 border-orange-600':''}`}>圖表</button>
            </div>
          )}

          <div className="flex-1 overflow-hidden relative bg-stone-50">
            {!isAdmin ? (
              (isMobile && viewMode === 'list') ? (
                <div className="h-full overflow-y-auto bg-white">
                  {tree.map(n => <MobileNode key={n.id} node={n} />)}
                </div>
              ) : (
                <div 
                  ref={scrollRef}
                  className={`h-full w-full overflow-auto p-10 ${drag.isDown ? 'cursor-grabbing' : 'cursor-grab'} scrollbar-hide`}
                  onMouseDown={onMouseDown} onMouseLeave={onMouseLeave} onMouseUp={onMouseUp} onMouseMove={onMouseMove}
                >
                  <div className="min-w-max" style={{transform: `scale(${zoom})`, transformOrigin: 'top center'}}>
                    <div className="flex justify-center pb-20">{tree.map(n => <Node key={n.id} node={n} isRoot={true} />)}</div>
                  </div>
                  <div className="fixed bottom-4 right-4 bg-white p-2 rounded shadow flex flex-col gap-2">
                    <button onClick={()=>setZoom(z=>Math.min(z+0.1, 2))}><Icon name="ZoomIn"/></button>
                    <button onClick={()=>setZoom(z=>Math.max(z-0.1, 0.5))}><Icon name="ZoomOut"/></button>
                  </div>
                </div>
              )
            ) : (
              <div className="h-full overflow-y-auto p-4 bg-white">
                <div className="mb-4 flex justify-between items-center">
                  <h2 className="font-bold text-lg">資料編輯</h2>
                  <div className="flex gap-2">
                    {isCloud && data.length===0 && <button onClick={initCloud} className="bg-blue-600 text-white px-3 py-1 rounded">初始化資料</button>}
                    <button onClick={handleAdd} className="bg-green-600 text-white px-3 py-1 rounded flex gap-1"><Icon name="Plus"/> 新增</button>
                  </div>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left">
                    <thead className="bg-stone-100"><tr><th className="p-2">ID</th><th className="p-2">姓名</th><th className="p-2">職稱</th><th className="p-2">管理職</th><th className="p-2">上級ID</th><th className="p-2">操作</th></tr></thead>
                    <tbody>
                      {data.map(emp => (
                        <tr key={emp.id} className="border-b">
                          {editId === emp.id ? (
                            <>
                              <td className="p-2"><input className="border p-1 w-full" value={form.id} onChange={e=>setForm({...form, id:e.target.value})}/></td>
                              <td className="p-2"><input className="border p-1 w-full" value={form.name} onChange={e=>setForm({...form, name:e.target.value})}/></td>
                              <td className="p-2"><input className="border p-1 w-full" value={form.title} onChange={e=>setForm({...form, title:e.target.value})}/></td>
                              <td className="p-2"><input className="border p-1 w-full" value={form.managementTitle} onChange={e=>setForm({...form, managementTitle:e.target.value})}/></td>
                              <td className="p-2"><input className="border p-1 w-full" value={form.parentId} onChange={e=>setForm({...form, parentId:e.target.value})}/></td>
                              <td className="p-2 flex gap-2">
                                <button onClick={handleSave} className="text-green-600"><Icon name="Save"/></button>
                                <button onClick={()=>setEditId(null)} className="text-stone-400">取消</button>
                              </td>
                            </>
                          ) : (
                            <>
                              <td className="p-2 font-mono text-xs">{emp.id}</td>
                              <td className="p-2 font-bold">{emp.name}</td>
                              <td className="p-2">{emp.title}</td>
                              <td className="p-2">{emp.managementTitle}</td>
                              <td className="p-2 font-mono text-xs">{emp.parentId}</td>
                              <td className="p-2 flex gap-2">
                                <button onClick={()=>{setEditId(emp.id); setForm(emp);}} className="text-blue-600"><Icon name="Edit"/></button>
                                <button onClick={()=>handleDel(emp.id)} className="text-red-600"><Icon name="Trash"/></button>
                              </td>
                            </>
                          )}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>

          {loginShow && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded shadow-lg w-80">
                <h3 className="font-bold mb-4">管理員登入</h3>
                <input type="password" placeholder="密碼" className="w-full border p-2 mb-4 rounded" value={pwd} onChange={e=>setPwd(e.target.value)} autoFocus />
                <div className="flex gap-2">
                  <button onClick={()=>{ if(pwd==='25773388'){setIsAdmin(true); setLoginShow(false); setPwd("");}else{alert("錯");} }} className="flex-1 bg-orange-500 text-white py-2 rounded">登入</button>
                  <button onClick={()=>setLoginShow(false)} className="flex-1 bg-stone-100 py-2 rounded">取消</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
